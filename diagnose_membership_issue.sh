#!/bin/bash

# Quick Telegram Verification Diagnostic
# Shows common issues and solutions

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Telegram 'Not a Member' Troubleshooting Guide"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "ğŸ“‹ Common Causes & Solutions:"
echo ""

echo "1ï¸âƒ£  WRONG CHAT ID FORMAT"
echo "   âŒ Issue: verification_data has wrong chat_id"
echo "   âœ… Solution: Verify chat_id format in quest"
echo "      â€¢ Public groups: @groupusername"
echo "      â€¢ Private/supergroups: -1001234567890"
echo "   ğŸ”§ How to get correct chat_id:"
echo "      â€¢ Forward message from group to @userinfobot"
echo "      â€¢ Or add @RawDataBot to the group"
echo ""

echo "2ï¸âƒ£  BOT NOT IN GROUP"
echo "   âŒ Issue: Bot needs to be member to check membership"
echo "   âœ… Solution: Add your bot to the group"
echo "      â€¢ Get bot username from .env (TELEGRAM_BOT_TOKEN)"
echo "      â€¢ Add bot as member or admin to the group"
echo "      â€¢ For channels, bot must be admin"
echo ""

echo "3ï¸âƒ£  USER PRIVACY SETTINGS"
echo "   âŒ Issue: User's privacy prevents bot from seeing them"
echo "   âœ… Solution: User must interact with bot first"
echo "      â€¢ User sends /start to your bot"
echo "      â€¢ This allows bot to see user's membership"
echo ""

echo "4ï¸âƒ£  USER ACTUALLY NOT JOINED"
echo "   âŒ Issue: User thinks they joined but didn't"
echo "   âœ… Solution: User needs to actually join the group"
echo "      â€¢ Click the group link"
echo "      â€¢ Click 'Join' button"
echo "      â€¢ Wait for confirmation"
echo "      â€¢ Then click 'Verify Me'"
echo ""

echo "5ï¸âƒ£  CACHED MEMBERSHIP STATUS"
echo "   âŒ Issue: Bot's cached data is outdated"
echo "   âœ… Solution: Wait a few seconds and retry"
echo "      â€¢ Telegram API may take time to update"
echo "      â€¢ User should wait 5-10 seconds after joining"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ Diagnostic Tools Available:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Run these commands to diagnose:"
echo ""
echo "1. Test membership verification:"
echo "   ./test_telegram_membership.sh"
echo ""
echo "2. Check backend logs for verification attempts:"
echo "   ./monitor_logs.sh backend"
echo ""
echo "3. Check if quest has correct chat_id:"
echo "   curl http://localhost:8000/api/tasks | jq '.[] | select(.task_type==\"telegram_group\") | {id, title, chat_id: .verification_data.chat_id}'"
echo ""
echo "4. Manual API test (replace values):"
echo "   curl 'https://api.telegram.org/bot<BOT_TOKEN>/getChatMember?chat_id=<CHAT_ID>&user_id=<USER_ID>'"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Check Quest Configuration:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v jq &> /dev/null; then
    echo ""
    echo "Telegram group quests in database:"
    curl -s http://localhost:8000/api/tasks 2>/dev/null | jq -r '.[] | select(.task_type == "telegram_group") | "ID: \(.id) | Title: \(.title) | Chat ID: \(.verification_data.chat_id // "âŒ MISSING")"'
else
    echo ""
    echo "âš ï¸  Install 'jq' to view quest configuration"
    echo "   sudo apt-get install jq"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¡ Quick Fix Checklist:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  [ ] Bot is added to the group as member/admin"
echo "  [ ] Chat ID in verification_data is correct format"
echo "  [ ] User has sent /start to the bot"
echo "  [ ] User has actually clicked JOIN in the group"
echo "  [ ] Waited 5-10 seconds after joining before verifying"
echo "  [ ] User's Telegram ID matches the one in database"
echo ""
echo "Run: ./test_telegram_membership.sh for detailed testing"
echo ""
