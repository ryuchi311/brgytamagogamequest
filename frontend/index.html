<!DOCTYPE html>
<!-- VERSION: 2.0.1 - Telegram Verification Update -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Gaming Quest Hub | Earn XP & Rewards</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Brgy Tamago Official Brand Colors
                        'brand-gold': '#fdbd16',        // Primary Gold/Yellow
                        'brand-red': '#f22524',         // Primary Red
                        'brand-black': '#1f1f20',       // Dark Background
                        'brand-white': '#ffffff',       // White
                        'brand-beige': '#e3c293',       // Tan/Beige accent
                        'brand-orange': '#ef6d1f',      // Orange accent
                        'brand-gray': '#585858',        // Gray (keeping from old)
                        
                        // Derived shades for gradients
                        'brand-gold-light': '#ffd03a',
                        'brand-gold-dark': '#e5aa00',
                        'brand-red-light': '#ff4447',
                        'brand-red-dark': '#d01619',
                        
                        // Legacy compatibility (mapped to new colors)
                        'gaming-dark': '#1f1f20',
                        'gaming-darker': '#151515',
                        'neon-blue': '#fdbd16',
                        'neon-purple': '#f22524',
                        'neon-pink': '#ff4447',
                        'neon-green': '#fdbd16',
                        'neon-yellow': '#ffd03a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');
        
        body { 
            font-family: 'Rajdhani', sans-serif; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, #202020 0%, #151515 50%, #202020 100%);
        }
        
        .gaming-title { font-family: 'Orbitron', sans-serif; }
        
        /* Brand Gradient Text - Gold to Red with shimmer */
        .gradient-text { 
            background: linear-gradient(90deg, #fdbd16 0%, #f22524 50%, #fdbd16 100%); 
            background-size: 200% auto;
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        /* Fade-in animation for welcome screen */
        @keyframes fade-in {
            from { 
                opacity: 0; 
                transform: scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: scale(1);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.5s ease-out;
        }
        
        /* Scale-in animation for modals */
        @keyframes scale-in {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-scale-in {
            animation: scale-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Pulse animation for participate button */
        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(253, 189, 22, 0.7);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(253, 189, 22, 0);
            }
        }
        
        /* Slow pulse animation for code input */
        @keyframes pulse-slow {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.8;
                transform: scale(1.02);
            }
        }
        
        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }
        
        /* Activity filter buttons */
        .activity-filter {
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .activity-filter.active {
            background: rgba(253, 189, 22, 0.3) !important;
            color: #fdbd16 !important;
            border: 1px solid rgba(253, 189, 22, 0.5);
        }
        .activity-filter:hover {
            transform: scale(1.05);
        }
        
        /* Quest category tabs */
        .quest-category-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            min-width: 80px;
        }
        .quest-category-tab:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }
        .quest-category-tab.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(181, 55, 242, 0.3));
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        
        /* Quest status badges */
        .quest-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .quest-status-available {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.5);
        }
        .quest-status-in-progress {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.5);
        }
        .quest-status-completed {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.5);
        }
        
        /* Hide scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .content-wrapper { padding-bottom: env(safe-area-inset-bottom, 80px); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 -4px 20px rgba(0, 212, 255, 0.3); padding-bottom: env(safe-area-inset-bottom, 0); }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 8px 0; transition: all 0.3s ease; position: relative; }
        .bottom-nav-item.active { color: #00d4ff; }
        .bottom-nav-item.active::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: linear-gradient(90deg, #00d4ff, #b537f2); border-radius: 0 0 10px 10px; }
        .bottom-nav-icon { font-size: 24px; line-height: 1; margin-bottom: 4px; }
        .bottom-nav-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Timer completion animation */
        @keyframes timer-complete {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes success-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.6), 0 0 60px rgba(34, 197, 94, 0.3); }
        }
        
        @keyframes slide-up {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .timer-complete-animation {
            animation: timer-complete 0.8s ease-out;
        }
        
        .success-glow-animation {
            animation: success-glow 2s ease-in-out infinite;
        }
        
        .slide-up-animation {
            animation: slide-up 0.5s ease-out;
        }
        
        /* Debug Log Styles */
        #twitterDebugLogContent {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.5) rgba(0, 0, 0, 0.3);
        }
        
        #twitterDebugLogContent::-webkit-scrollbar {
            width: 8px;
        }
        
        #twitterDebugLogContent::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        #twitterDebugLogContent::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 4px;
        }
        
        #twitterDebugLogContent::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }
        
        #twitterDebugLogLines > div {
            padding: 2px 0;
            line-height: 1.5;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gaming-darker text-white">
    <div class="min-h-screen bg-gradient-to-br from-gaming-darker via-gaming-dark to-gaming-darker">
        <div class="content-wrapper">
            <header class="bg-gradient-to-r from-gaming-dark/95 to-purple-900/60 backdrop-blur-lg shadow-2xl p-4 mb-4 border-b border-neon-blue/30 sticky top-0 z-40">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-neon-blue to-neon-purple rounded-xl flex items-center justify-center text-2xl">🎮</div>
                        <div>
                            <h1 class="text-xl font-black gaming-title gradient-text leading-none">QUEST HUB</h1>
                            <p class="text-neon-blue text-xs">Earn XP  • Level Up</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="bg-gradient-to-r from-neon-purple to-neon-pink px-4 py-2 rounded-xl border border-neon-pink/50">
                            <div class="text-xs text-gray-300 leading-none mb-1">XP</div>
                            <div id="userPoints" class="text-lg font-black gaming-title leading-none">...</div>
                        </div>
                        <div id="serverStatus" class="p-2 rounded-lg" title="Server Status">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="8" />
                            </svg>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ON-SCREEN DEBUG PANEL (for Telegram Mini App) -->
            <div id="debugPanel" class="fixed bottom-20 right-2 w-80 max-h-96 bg-black/95 border-2 border-yellow-400 rounded-lg overflow-hidden shadow-2xl z-50 hidden">
                <div class="bg-yellow-400 text-black px-3 py-2 flex items-center justify-between">
                    <span class="font-bold text-sm">🔍 Debug Log</span>
                    <div class="flex gap-2">
                        <button onclick="testCodeInput()" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600" title="Test Code Input">Test</button>
                        <button onclick="clearDebugLog()" class="text-xs bg-black/20 px-2 py-1 rounded hover:bg-black/40">Clear</button>
                        <button onclick="toggleDebugPanel()" class="text-xs bg-black/20 px-2 py-1 rounded hover:bg-black/40">×</button>
                    </div>
                </div>
                <div id="debugLog" class="p-2 overflow-y-auto max-h-80 text-xs font-mono">
                    <div class="text-green-400">Debug panel ready...</div>
                </div>
            </div>
            
            <!-- Debug Toggle Button -->
            <button onclick="toggleDebugPanel()" class="fixed bottom-24 right-2 w-12 h-12 bg-yellow-400 text-black rounded-full shadow-lg z-50 font-bold text-xl hover:bg-yellow-300 active:scale-95 transition-all">
                🐛
            </button>

            <main class="px-4 pb-4">
                <!-- QUEST LIST VIEW -->
                <section id="tasks" class="tab-content pb-24">
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-xl font-black gaming-title gradient-text">⚔️ Quests</h2>
                            <span id="tasksCount" class="text-xs bg-neon-blue/20 px-2 py-1 rounded-full">0</span>
                        </div>
                        
                        <!-- Quest Category Tabs -->
                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            <button onclick="filterQuestsByCategory('all')" class="quest-category-tab active" data-category="all">
                                <span class="text-base">🎯</span>
                                <span class="text-xs font-bold">All</span>
                            </button>
                            <button onclick="filterQuestsByCategory('daily')" class="quest-category-tab" data-category="daily">
                                <span class="text-base">📅</span>
                                <span class="text-xs font-bold">Daily</span>
                            </button>
                            <button onclick="filterQuestsByCategory('special')" class="quest-category-tab" data-category="special">
                                <span class="text-base">⭐</span>
                                <span class="text-xs font-bold">Special</span>
                            </button>
                            <button onclick="filterQuestsByCategory('partner')" class="quest-category-tab" data-category="partner">
                                <span class="text-base">🤝</span>
                                <span class="text-xs font-bold">Partner</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="tasksContainer" class="space-y-3 pb-6">
                        <div class="text-center py-12 text-neon-blue">⚡ Loading Quests...</div>
                    </div>
                </section>

                <!-- UNIFIED QUEST DETAIL PAGE (Dynamic based on task_type) -->
                <section id="questDetailPage" class="tab-content hidden">
                    <div class="min-h-screen pb-20">
                        <!-- Back Button -->
                        <button onclick="backToQuestList()" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4 p-2">
                            <span class="text-xl">←</span>
                        </button>
                        
                        <!-- Quest Title Section - Compact -->
                        <div class="text-center mb-4">
                            <h1 class="text-xl font-bold mb-2" id="questTitle">Quest Title</h1>
                            <p class="text-gray-400 text-xs mb-4" id="questDescription">Complete this quest to earn rewards</p>
                            
                            <!-- Reward Display - Compact -->
                            <div class="inline-flex items-center gap-2 bg-gaming-dark/60 rounded-xl px-4 py-2 border border-yellow-500/30">
                                <div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center">
                                    <span class="text-lg">●</span>
                                </div>
                                <div class="text-left">
                                    <div class="text-[10px] text-gray-400 uppercase tracking-wide">Reward</div>
                                    <div class="text-base font-black text-yellow-400" id="questPoints">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions Section (Different per task type) -->
                        <div id="questInstructions" class="mb-4"></div>

                        <!-- Dynamic Content Area (Changes based on task_type) -->
                        <div id="questDynamicContent"></div>

                        <!-- Action Button (Start Mission / Claim) -->
                        <div id="questActionButton" class="mb-6"></div>

                        <!-- Your Tasks Section -->
                        <div id="questTasksSection">
                            <h3 class="text-lg font-bold mb-4">Your tasks</h3>
                            <div id="questTasksList" class="space-y-3">
                                <!-- Tasks will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- LEGACY: Keep for backward compatibility, hide by default -->
                <section id="youtubeQuestPage" class="tab-content hidden" style="display: none !important;">
                    <div class="min-h-screen pb-24">
                        <!-- Back Button -->
                        <button onclick="backToQuestList()" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-6 p-2">
                            <span class="text-2xl">←</span>
                        </button>
                        
                        <!-- Quest Title Section -->
                        <div class="text-center mb-8">
                            <h1 class="text-2xl font-black mb-3" id="ytQuestTitle">Watch Our YouTube Video</h1>
                            <p class="text-gray-400 text-sm mb-6" id="ytQuestDescription">Watch the video and find the secret code</p>
                            
                            <!-- Reward Display -->
                            <div class="inline-flex items-center gap-2 bg-gaming-dark/60 rounded-2xl px-6 py-3 border border-neon-blue/30">
                                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center">
                                    <span class="text-2xl">●</span>
                                </div>
                                <div class="text-left">
                                    <div class="text-xs text-gray-400">Reward</div>
                                    <div class="text-lg font-black text-yellow-400" id="ytQuestPoints">5 000</div>
                                </div>
                            </div>
                        </div>

                        <!-- Watch Video Button -->
                        <button onclick="openYouTubeVideo()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                            📺 Watch Video
                        </button>

                        <!-- Timer Display (hidden initially) -->
                        <div id="ytTimerDisplay" class="hidden mb-4 bg-gaming-dark/60 rounded-2xl p-4 border border-yellow-500/30">
                            <div class="text-center">
                                <p class="text-xs text-gray-400 mb-2">⏱️ Watch Timer</p>
                                <div class="text-3xl font-black text-yellow-400 mb-2" id="ytTimerCountdown">--:--</div>
                                <div class="w-full bg-gaming-darker rounded-full h-2 overflow-hidden mb-2">
                                    <div id="ytTimerProgress" class="h-full bg-gradient-to-r from-yellow-500 to-green-500 transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <span class="text-xs text-gray-400" id="ytTimerStatus">⏳ Keep watching...</span>
                            </div>
                        </div>

                        <!-- Your Tasks Section -->
                        <div>
                            <h3 class="text-lg font-bold mb-4">Your tasks</h3>
                            
                            <div class="space-y-3">
                                <!-- Task 1: Watch Video -->
                                <div class="bg-gaming-dark/60 rounded-xl p-4 border border-neon-blue/20">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm text-gray-300">Watch the video completely</p>
                                        </div>
                                        <div class="ml-3 text-gray-500">
                                            <span class="text-xl">›</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task 2: Enter Code (Initially Locked) -->
                                <div class="bg-gaming-dark/60 rounded-xl p-4 border border-neon-blue/20">
                                    <div class="relative">
                                        <!-- Lock Overlay -->
                                        <div id="ytCodeLockOverlay" class="absolute inset-0 bg-gaming-dark/95 backdrop-blur-sm rounded-xl z-10 flex items-center justify-center">
                                            <div class="text-center">
                                                <div class="text-3xl mb-2">🔒</div>
                                                <p class="text-sm font-bold text-gray-400">Watch video first</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Code Input -->
                                        <div>
                                            <p class="text-sm text-gray-300 mb-3">Enter verification code</p>
                                            <input type="text" id="ytVerificationCode" disabled placeholder="Watch the video first" class="w-full bg-gaming-darker/80 border-2 border-yellow-500/50 rounded-xl px-4 py-3 text-center font-bold tracking-wider placeholder-gray-600 focus:outline-none focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/30 transition-all disabled:opacity-50 mb-3">
                                            <p class="text-xs text-gray-400 text-center" id="ytCodeInputHint">⏱️ Watch the video to unlock code input</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button id="ytSubmitButton" onclick="submitYouTubeQuest()" disabled class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-2xl p-4 font-bold text-lg mt-6 active:scale-95 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="ytSubmitButtonText">Submit Code</span>
                        </button>
                    </div>
                </section>

                <!-- REGULAR QUEST DETAIL PAGE (Twitter, Telegram, Discord, Instagram) -->
                <section id="regularQuestPage" class="tab-content hidden" style="display: none !important;">
                    <div class="min-h-screen pb-24">
                        <!-- Back Button -->
                        <button onclick="backToQuestList()" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-6 p-2">
                            <span class="text-2xl">←</span>
                        </button>
                        
                        <!-- Quest Title Section -->
                        <div class="text-center mb-8">
                            <h1 class="text-2xl font-black mb-3" id="regQuestTitle">Be a part of crypto degen club!</h1>
                            <p class="text-gray-400 text-sm mb-6" id="regQuestDescription">Subscribe to the crypto news channel!</p>
                            
                            <!-- Reward Display -->
                            <div class="inline-flex items-center gap-2 bg-gaming-dark/60 rounded-2xl px-6 py-3 border border-neon-blue/30">
                                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center">
                                    <span class="text-2xl">●</span>
                                </div>
                                <div class="text-left">
                                    <div class="text-xs text-gray-400">Reward</div>
                                    <div class="text-lg font-black text-yellow-400" id="regQuestPoints">1 000</div>
                                </div>
                            </div>
                        </div>

                        <!-- Start Mission Button -->
                        <button id="regQuestButton" onclick="submitRegularQuest()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                            <span id="regQuestButtonText">Start mission</span>
                        </button>

                        <!-- Your Tasks Section -->
                        <div>
                            <h3 class="text-lg font-bold mb-4">Your tasks</h3>
                            
                            <div class="space-y-3">
                                <!-- Task Item -->
                                <div class="bg-gaming-dark/60 rounded-xl p-4 border border-neon-blue/20">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm text-gray-300" id="regTaskDescription">Join the Telegram chat</p>
                                        </div>
                                        <div class="ml-3 text-gray-500" id="regTaskStatus">
                                            <span class="text-xl">›</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="leaderboard" class="tab-content hidden">
                    <div class="mb-3">
                        <h2 class="text-xl font-black gaming-title gradient-text">🏆 Top Players</h2>
                    </div>
                    <div id="leaderboardContainer" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <div class="animate-spin text-4xl mb-2">⚡</div>
                            <div>Loading rankings...</div>
                        </div>
                    </div>
                </section>

                <section id="rewards" class="tab-content hidden">
                    <div class="mb-3">
                        <h2 class="text-xl font-black gaming-title gradient-text">�� Epic Loot</h2>
                    </div>
                    <div id="rewardsContainer" class="space-y-3">
                        <div class="text-center py-12 text-neon-blue">Loading rewards...</div>
                    </div>
                </section>

                <section id="profile" class="tab-content hidden">
                    <div class="mb-2">
                        <h2 class="text-lg font-black gaming-title gradient-text">👤 Your Profile</h2>
                    </div>
                    <div class="space-y-2">
                        <!-- User Stats Card -->
                        <div class="bg-gaming-dark/80 backdrop-blur-md rounded-xl p-3 border border-neon-blue/30">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-neon-blue to-neon-purple rounded-full flex items-center justify-center text-2xl">👤</div>
                                <div class="flex-1">
                                    <div class="text-base font-bold gaming-title" id="profileUsername">Player</div>
                                    <div class="text-xs text-gray-400">Level <span id="profileLevel">1</span></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center">
                                    <div class="text-xl font-black gaming-title text-neon-blue" id="profileQuests">0</div>
                                    <div class="text-xs text-gray-400">Quests</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center">
                                    <div class="text-xl font-black gaming-title text-neon-purple" id="profileRank">-</div>
                                    <div class="text-xs text-gray-400">Rank</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center">
                                    <div class="text-xl font-black gaming-title text-neon-pink" id="profileXP">0</div>
                                    <div class="text-xs text-gray-400">XP</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quest Activity Log -->
                        <div class="bg-gaming-dark/80 backdrop-blur-md rounded-xl p-3 border border-brand-gold/30">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-base font-black gaming-title text-brand-gold">📜 Quest Activity</h3>
                                <div class="flex gap-1 text-xs">
                                    <button onclick="filterActivity('all')" id="filterAll" class="activity-filter active px-2 py-1 rounded-full bg-brand-gold/20 text-brand-gold text-xs">All</button>
                                    <button onclick="filterActivity('success')" id="filterSuccess" class="activity-filter px-2 py-1 rounded-full bg-gray-700/50 text-gray-400 text-xs">✓</button>
                                    <button onclick="filterActivity('failed')" id="filterFailed" class="activity-filter px-2 py-1 rounded-full bg-gray-700/50 text-gray-400 text-xs">✗</button>
                                </div>
                            </div>
                            
                            <!-- Activity Stats -->
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center border border-gray-700/30">
                                    <div class="text-sm font-bold text-green-400" id="successCount">0</div>
                                    <div class="text-xs text-gray-500">Success</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center border border-gray-700/30">
                                    <div class="text-sm font-bold text-red-400" id="failedCount">0</div>
                                    <div class="text-xs text-gray-500">Failed</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center border border-gray-700/30">
                                    <div class="text-sm font-bold text-blue-400" id="successRate">0%</div>
                                    <div class="text-xs text-gray-500">Rate</div>
                                </div>
                            </div>

                            <!-- Activity List -->
                            <div id="activityContainer" class="space-y-2 max-h-80 overflow-y-auto">
                                <div class="text-center py-6 text-gray-500 text-sm">
                                    <div class="text-3xl mb-2">🎯</div>
                                    <div>Complete quests to see your activity!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="notifications" class="tab-content hidden">
                    <div class="mb-3">
                        <h2 class="text-xl font-black gaming-title gradient-text">📡 Mission Control</h2>
                    </div>
                    <div id="notificationsContainer" class="space-y-2">
                        <div class="text-center py-12 text-neon-blue">Loading alerts...</div>
                    </div>
                </section>
            </main>
        </div>

        <nav class="bottom-nav bg-gaming-dark/95 border-t border-neon-blue/30">
            <div class="flex items-center justify-around max-w-xl mx-auto">
                <button class="bottom-nav-item active" onclick="showTab('tasks', this)">
                    <div class="bottom-nav-icon">⚔️</div>
                    <div class="bottom-nav-label">Quests</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('leaderboard', this)">
                    <div class="bottom-nav-icon">🏆</div>
                    <div class="bottom-nav-label">Ranks</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('rewards', this)">
                    <div class="bottom-nav-icon">💎</div>
                    <div class="bottom-nav-label">Rewards</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('profile', this)">
                    <div class="bottom-nav-icon">👤</div>
                    <div class="bottom-nav-label">Profile</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('notifications', this)">
                    <div class="bottom-nav-icon">📡</div>
                    <div class="bottom-nav-label">Alerts</div>
                </button>
            </div>
        </nav>
    </div>

    <!-- Telegram Username Input Modal -->
    <div id="telegramUsernameModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden flex items-center justify-center">
        <div class="bg-gaming-dark w-full max-w-md mx-4 rounded-3xl border-2 border-neon-blue/30 shadow-[0_0_50px_rgba(0,149,255,0.3)] overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 p-6 border-b border-neon-blue/30">
                <h3 class="text-2xl font-black gaming-title gradient-text text-center">🔐 Telegram Verification</h3>
                <p class="text-sm text-gray-300 text-center mt-2">Enter your Telegram username to verify</p>
            </div>
            
            <!-- Content -->
            <div class="p-6 space-y-4">
                <!-- Group Name Display -->
                <div class="bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/30 rounded-xl p-4 text-center">
                    <p class="text-xs text-gray-400 mb-1">Verifying membership for:</p>
                    <p class="text-lg font-bold text-cyan-300" id="telegramGroupName">Loading...</p>
                </div>
                
                <!-- Info Box -->
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">ℹ️</span>
                        <div class="flex-1 text-sm text-gray-300">
                            <p class="font-bold text-blue-300 mb-1">Why we need this:</p>
                            <p>We'll check if you're a member of the Telegram group using your username.</p>
                        </div>
                    </div>
                </div>

                <!-- Username Input -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Telegram Username</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg">@</span>
                        <input 
                            type="text" 
                            id="telegramUsernameInput" 
                            placeholder="username" 
                            class="w-full pl-10 pr-12 py-3 bg-gaming-darker border-2 border-neon-blue/30 rounded-xl text-white placeholder-gray-500 focus:border-neon-blue focus:outline-none focus:ring-2 focus:ring-neon-blue/50 transition-all"
                            autocomplete="off"
                            oninput="validateUsernameRealtime()"
                        />
                        <!-- Validation Indicator -->
                        <div id="usernameValidationIndicator" class="absolute right-4 top-1/2 -translate-y-1/2 hidden">
                            <span id="validationSpinner" class="text-gray-400 animate-spin hidden">⏳</span>
                            <span id="validationCheck" class="text-green-400 text-xl hidden">✓</span>
                            <span id="validationCross" class="text-red-400 text-xl hidden">✗</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2" id="usernameHelper">Enter without the @ symbol</p>
                    <!-- Success Message -->
                    <div id="usernameSuccess" class="hidden mt-2 text-sm text-green-400 flex items-center gap-2">
                        <span>✓</span>
                        <span>Username found in database</span>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="usernameError" class="hidden bg-red-500/10 border border-red-500/30 rounded-xl p-3 text-sm text-red-300">
                    <span class="font-bold">❌ Error:</span> <span id="usernameErrorText"></span>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-2">
                    <button 
                        onclick="closeTelegramUsernameModal()" 
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl transition-all active:scale-95"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="submitTelegramVerification()" 
                        id="usernameSubmitBtn"
                        disabled
                        class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-xl transition-all active:scale-95 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="usernameSubmitBtnText">✅ Verify</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center">
        <div class="bg-gaming-dark w-full md:max-w-lg md:rounded-3xl rounded-t-3xl border-t md:border border-neon-blue/30 shadow-[0_0_50px_rgba(0,149,255,0.3)] max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gaming-dark/95 backdrop-blur-md p-4 border-b border-neon-blue/30 flex items-center justify-between">
                <h3 class="text-xl font-black gaming-title gradient-text" id="modalTitle">Quest Details</h3>
                <button onclick="closeTaskModal()" class="text-3xl text-gray-400 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="p-6 space-y-5">
                <!-- Quest Header with Platform Badge -->
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-neon-blue/20 to-neon-purple/20 rounded-2xl blur-xl"></div>
                    <div class="relative flex items-center gap-5 bg-gradient-to-r from-gaming-darker to-gaming-dark rounded-2xl p-5 border-2 border-neon-blue/40">
                        <div class="text-6xl drop-shadow-[0_0_20px_rgba(0,212,255,0.5)]" id="modalEmoji">🎯</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 bg-neon-blue/20 border border-neon-blue/50 rounded-full text-xs font-bold text-neon-blue uppercase tracking-wider" id="modalPlatform">Platform</span>
                            </div>
                            <div class="text-3xl font-black gaming-title text-neon-green drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]" id="modalPoints">+0 XP</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quest Description -->
                <div class="bg-gradient-to-br from-gaming-darker/80 to-gaming-dark/80 rounded-xl p-5 border border-neon-blue/20">
                    <h4 class="text-sm font-bold text-neon-blue mb-2 uppercase tracking-wide">📋 Quest Objective</h4>
                    <p class="text-base text-gray-200 leading-relaxed" id="modalDescription">Quest description goes here</p>
                </div>
                
                <!-- Regular Quest Instructions (for non-YouTube quests) -->
                <div id="regularQuestSection" class="hidden space-y-4">
                    <!-- How It Works -->
                    <div class="bg-gradient-to-r from-purple-500/20 to-blue-500/20 border-2 border-purple-500/50 rounded-xl p-5">
                        <h4 class="text-lg font-black text-purple-300 mb-3 flex items-center gap-2">
                            <span>⚡</span>
                            <span>HOW IT WORKS</span>
                        </h4>
                        <ol class="space-y-2 text-sm text-gray-200">
                            <li class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                                <span>Click the button below to open the quest</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-xs font-bold">2</span>
                                <span>Complete the required action on the platform</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-xs font-bold">3</span>
                                <span>Quest will auto-verify and reward you XP!</span>
                            </li>
                        </ol>
                    </div>
                </div>
                
                <!-- YouTube Quest Flow: Watch First, Then Enter Code -->
                <div id="youtubeWatchSection" class="hidden space-y-4">
                    <!-- Large Step 1 Header -->
                    <div class="text-center py-3 bg-gradient-to-r from-red-500/30 to-pink-500/30 rounded-xl border-2 border-red-500">
                        <p class="text-2xl font-black gaming-title text-red-300 mb-1">📺 STEP 1</p>
                        <p class="text-sm font-bold text-white">WATCH THE VIDEO</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-red-500/20 to-pink-500/20 border-2 border-red-500/50 rounded-xl p-5 text-center">
                        <p class="text-base font-bold text-white mb-2">🎥 Click below to watch the video</p>
                        <p class="text-sm text-gray-300">👀 Look for the SECRET CODE in the video</p>
                        <p class="text-xs text-red-300 mt-2">⚡ You'll enter it after watching!</p>
                    </div>
                    
                    <button onclick="openVideoAndShowCodeInput()" class="w-full bg-gradient-to-r from-red-600 to-pink-600 text-white font-black py-5 px-6 rounded-xl text-lg hover:shadow-[0_0_40px_rgba(255,0,100,0.6)] transition-all active:scale-95 border-2 border-red-400">
                        <span class="text-2xl">📺</span>
                        <span class="ml-2">WATCH VIDEO NOW</span>
                    </button>
                </div>
                
                <!-- Code Input for YouTube/Time-delay quests (Shows AFTER watching) -->
                <!-- OLD VERSION - HIDDEN - Using dynamic version now -->
                <div id="oldStaticCodeInputSection" style="display: none !important;" class="hidden space-y-4">
                    <!-- Large Step 2 Header -->
                    <div class="text-center py-3 bg-gradient-to-r from-yellow-500/30 to-orange-500/30 rounded-xl border-2 border-yellow-500 animate-pulse-slow">
                        <p class="text-2xl font-black gaming-title text-yellow-300 mb-1">🔑 STEP 2</p>
                        <p class="text-sm font-bold text-white">ENTER THE CODE</p>
                    </div>
                    
                    <!-- Timer Display -->
                    <div id="timerDisplay" class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-2 border-blue-500/50 rounded-xl p-4 text-center hidden">
                        <p class="text-xs text-gray-400 mb-2">⏱️ Watch Timer</p>
                        <div class="text-4xl font-black gaming-title text-neon-blue mb-2" id="timerCountdown">--:--</div>
                        <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                            <div id="timerProgress" class="bg-gradient-to-r from-neon-blue to-neon-purple h-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">
                            <span id="timerStatus">⏳ Keep watching...</span>
                        </p>
                    </div>
                    
                    <!-- Code Input Instructions -->
                    <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-2 border-yellow-500/50 rounded-xl p-5 text-center">
                        <p class="text-lg font-bold text-yellow-300 mb-2">� Type the code you found!</p>
                        <p class="text-sm text-gray-300">
                            The verification code was shown at <span id="codeTime" class="font-bold text-yellow-400">during the video</span>
                        </p>
                    </div>
                    
                    <!-- Large Prominent Code Input (LOCKED until timer ends) -->
                    <div class="relative" id="codeInputContainer">
                        <!-- Lock Overlay (shows when timer is running) -->
                        <div id="codeLockOverlay" class="absolute inset-0 bg-gaming-dark/90 backdrop-blur-sm rounded-xl flex items-center justify-center z-10 hidden">
                            <div class="text-center">
                                <div class="text-5xl mb-3 animate-pulse">🔒</div>
                                <p class="text-lg font-bold text-red-400">INPUT LOCKED</p>
                                <p class="text-sm text-gray-400 mt-1">Complete watch timer first</p>
                            </div>
                        </div>
                        
                        <!-- Glowing halo effect -->
                        <div class="absolute -inset-1 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl blur opacity-50 animate-pulse-slow"></div>
                        
                        <!-- Code input field -->
                        <input 
                            type="text" 
                            id="verificationCode" 
                            placeholder="ENTER CODE HERE"
                            disabled
                            class="relative w-full bg-gaming-darker border-4 border-yellow-500 rounded-xl px-6 py-5 text-white placeholder-yellow-600/50 focus:outline-none focus:border-yellow-400 focus:shadow-[0_0_30px_rgba(234,179,8,0.5)] transition-all text-center text-2xl font-black tracking-widest uppercase disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                    </div>
                    
                    <div class="text-center text-xs text-gray-400">
                        <p id="codeInputHint">🔒 Complete the watch timer to unlock code input</p>
                    </div>
                </div>
                <!-- END OF OLD SECTION - NOW HIDDEN -->

                <!-- Action Button Section -->
                <div class="space-y-3">
                    <!-- Regular quest button (non-YouTube) OR Submit code button (YouTube after watching) -->
                    <div class="relative">
                        <div class="absolute -inset-1 bg-gradient-to-r from-neon-blue to-neon-purple rounded-xl blur-lg opacity-50"></div>
                        <button id="questActionButton" onclick="completeTask()" class="relative w-full bg-gradient-to-r from-neon-blue to-neon-purple text-white font-black py-6 px-8 rounded-xl text-xl hover:shadow-[0_0_50px_rgba(0,149,255,0.8)] transition-all active:scale-95 border-2 border-blue-300 flex items-center justify-center gap-3">
                            <span class="text-3xl">🚀</span>
                            <span>START QUEST</span>
                        </button>
                    </div>
                    
                    <!-- Quest Info Footer -->
                    <div class="flex items-center justify-center gap-4 text-xs text-gray-400">
                        <div class="flex items-center gap-1">
                            <span>⚡</span>
                            <span>Instant Verification</span>
                        </div>
                        <div class="w-1 h-1 bg-gray-600 rounded-full"></div>
                        <div class="flex items-center gap-1">
                            <span>🎁</span>
                            <span>Auto Rewards</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - API URL
        // Handle both localhost and GitHub Codespaces URLs
        let API_BASE;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Local development
            API_BASE = window.location.origin.replace(':8080', ':8000');
        } else {
            // GitHub Codespaces - replace 8080 port in URL
            API_BASE = window.location.origin.replace('-8080.', '-8000.');
        }
        const API_URL = `${API_BASE}/api`;
        
        // Telegram Mini App Integration
        // ⚠️ TELEGRAM LOGIN DISABLED - Using default test user
        let TELEGRAM_ID = 1271737596; // Default test user ID
        let TELEGRAM_USER = {
            id: 1271737596,
            first_name: 'Test',
            last_name: 'User',
            username: 'testuser'
        };
        console.log('⚠️ Telegram login disabled - Using test user:', TELEGRAM_USER);
        
        // Initialize Telegram WebApp (if available, will override test user)
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // Get user data from Telegram (will override test user if available)
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                TELEGRAM_USER = tg.initDataUnsafe.user;
                TELEGRAM_ID = TELEGRAM_USER.id;
                console.log('✅ Telegram user authenticated (overriding test user):', TELEGRAM_USER);
            }
        }

        // ============================================
        // ON-SCREEN DEBUG PANEL (for Telegram Mini App)
        // ============================================
        
        let debugLogs = [];
        let isDebugPanelVisible = false;
        
        // Override console.log to capture all logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addDebugLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                log: '#00ff00',
                error: '#ff0000',
                warn: '#ffaa00',
                info: '#00aaff'
            };
            
            debugLogs.push({
                time: timestamp,
                message: String(message),
                type: type,
                color: colors[type]
            });
            
            // Keep only last 100 logs
            if (debugLogs.length > 100) {
                debugLogs.shift();
            }
            
            // Update debug panel if it exists
            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            const debugLog = document.getElementById('debugLog');
            if (!debugLog) return;
            
            debugLog.innerHTML = debugLogs.map(log => 
                `<div style="color: ${log.color}; margin-bottom: 4px;">
                    <span style="color: #666;">[${log.time}]</span> ${log.message}
                </div>`
            ).join('');
            
            // Auto-scroll to bottom
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                isDebugPanelVisible = !isDebugPanelVisible;
                panel.classList.toggle('hidden', !isDebugPanelVisible);
            }
        }
        
        function clearDebugLog() {
            debugLogs = [];
            updateDebugPanel();
            addDebugLog('Debug log cleared', 'info');
        }
        
        // Override console methods
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addDebugLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addDebugLog('❌ ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addDebugLog('⚠️ ' + args.join(' '), 'warn');
        };
        
        // Add initial log
        addDebugLog('🐛 Debug system initialized', 'info');
        addDebugLog('Click 🐛 button to toggle debug panel', 'info');
        
        // ============================================
        // TEST MODE - Set to true for 5 second timer
        // ============================================
        const TEST_MODE = true; // Set to false for production (30 second timer)
        
        if (TEST_MODE) {
            addDebugLog('⚡ TEST MODE ACTIVE - Timer is 5 seconds!', 'warn');
        }
        
        // Test function for code input
        function testCodeInput() {
            addDebugLog('━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            addDebugLog('🧪 TESTING CODE INPUT', 'info');
            
            const el = document.getElementById('codeInputSection');
            addDebugLog('Element: ' + (el ? 'FOUND ✅' : 'NOT FOUND ❌'), el ? 'log' : 'error');
            
            if (el) {
                addDebugLog('Parent: ' + (el.parentElement ? el.parentElement.id || 'no ID' : 'none'), 'log');
                addDebugLog('Classes: ' + el.className, 'log');
                addDebugLog('Display: ' + window.getComputedStyle(el).display, 'log');
                
                addDebugLog('Attempting to show...', 'info');
                el.classList.remove('hidden');
                el.style.display = 'block';
                el.style.visibility = 'visible';
                el.style.border = '3px solid red';
                
                setTimeout(() => {
                    const newDisplay = window.getComputedStyle(el).display;
                    addDebugLog('New display: ' + newDisplay, newDisplay === 'block' ? 'log' : 'error');
                    addDebugLog(newDisplay === 'block' ? '✅ Should be visible now with RED BORDER' : '❌ Still hidden!', newDisplay === 'block' ? 'log' : 'error');
                }, 100);
            } else {
                addDebugLog('Searching for similar elements...', 'warn');
                const similar = document.querySelectorAll('[id*="codeInput"]');
                addDebugLog('Found ' + similar.length + ' elements with "codeInput"', 'info');
                similar.forEach((elem, i) => {
                    addDebugLog(`  ${i+1}. id="${elem.id}"`, 'log');
                });
            }
            
            addDebugLog('━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
        }
        
        // ============================================
        // END DEBUG PANEL
        // ============================================

        
        // Track if user has started participating
        let userHasParticipated = false;
        
        // Check if user is authenticated via Telegram
        function checkTelegramAuth() {
            if (!TELEGRAM_ID) {
                // Show authentication required message
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-gaming-darker via-gaming-dark to-gaming-darker flex items-center justify-center p-6">
                        <div class="max-w-md w-full bg-gaming-dark/90 backdrop-blur-md rounded-3xl p-8 border-2 border-brand-gold/30 text-center">
                            <div class="text-6xl mb-6">🔒</div>
                            <h1 class="text-3xl font-black gaming-title gradient-text mb-4">TELEGRAM REQUIRED</h1>
                            <p class="text-gray-300 mb-6 leading-relaxed">
                                This is a Telegram Mini App. You must access it through Telegram to participate in quests and earn rewards.
                            </p>
                            <div class="bg-brand-gold/10 border border-brand-gold/30 rounded-xl p-4 mb-6">
                                <div class="text-sm font-bold text-brand-gold mb-2">📱 How to Access:</div>
                                <ol class="text-xs text-left text-gray-300 space-y-2 ml-4 list-decimal">
                                    <li>Open Telegram app</li>
                                    <li>Search for our bot</li>
                                    <li>Click "Start" or "Play Game"</li>
                                    <li>Complete quests & earn XP!</li>
                                </ol>
                            </div>
                            <div class="text-xs text-gray-500 mt-6">
                                ⚠️ Direct browser access is not supported
                            </div>
                        </div>
                    </div>
                `;
                return false;
            }
            return true;
        }
        
        // Show welcome screen with participate button
        function showWelcomeScreen() {
            const welcomeScreen = document.createElement('div');
            welcomeScreen.id = 'welcomeScreen';
            welcomeScreen.className = 'fixed inset-0 z-50 bg-gradient-to-br from-gaming-darker via-gaming-dark to-gaming-darker flex items-center justify-center p-6';
            welcomeScreen.innerHTML = `
                <div class="max-w-lg w-full bg-gaming-dark/95 backdrop-blur-xl rounded-3xl p-8 border-2 border-brand-gold/50 text-center shadow-2xl animate-fade-in">
                    <div class="text-7xl mb-6 animate-bounce">🎮</div>
                    <h1 class="text-4xl font-black gaming-title gradient-text mb-4 leading-tight">
                        WELCOME TO<br>QUEST HUB!
                    </h1>
                    <div class="bg-brand-gold/10 border border-brand-gold/30 rounded-2xl p-5 mb-6">
                        <div class="text-lg font-bold text-brand-gold mb-2">👋 Hey ${TELEGRAM_USER.first_name || 'Player'}!</div>
                        <p class="text-gray-300 text-sm leading-relaxed">
                            You're about to embark on an epic quest journey! Complete challenges, earn XP, and unlock awesome rewards.
                        </p>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="bg-gaming-darker/50 rounded-xl p-3">
                            <div class="text-2xl mb-1">⚔️</div>
                            <div class="text-xs text-gray-400">Epic<br>Quests</div>
                        </div>
                        <div class="bg-gaming-darker/50 rounded-xl p-3">
                            <div class="text-2xl mb-1">💎</div>
                            <div class="text-xs text-gray-400">Earn<br>XP</div>
                        </div>
                        <div class="bg-gaming-darker/50 rounded-xl p-3">
                            <div class="text-2xl mb-1">🏆</div>
                            <div class="text-xs text-gray-400">Win<br>Rewards</div>
                        </div>
                    </div>
                    <button 
                        onclick="startParticipating()" 
                        class="w-full bg-gradient-to-r from-brand-gold to-brand-orange hover:from-brand-gold-light hover:to-brand-gold text-gaming-dark font-black text-lg py-4 px-8 rounded-xl transition-all transform hover:scale-105 active:scale-95 shadow-lg gaming-title"
                        style="animation: pulse 2s infinite;">
                        🚀 PARTICIPATE NOW!
                    </button>
                    <div class="mt-4 text-xs text-gray-500">
                        ✨ No signup required • Start playing instantly!
                    </div>
                </div>
            `;
            document.body.appendChild(welcomeScreen);
        }
        
        // Start participating - initialize user and load game
        async function startParticipating() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const button = welcomeScreen.querySelector('button');
            
            // Show loading state
            button.innerHTML = '⏳ Initializing...';
            button.disabled = true;
            
            try {
                // Check if user exists, if not create account
                let response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                
                if (response.status === 404) {
                    // Create new user automatically
                    const username = TELEGRAM_USER.username || `player${TELEGRAM_ID}`;
                    const firstName = TELEGRAM_USER.first_name || 'Player';
                    const lastName = TELEGRAM_USER.last_name || '';
                    
                    button.innerHTML = '🎨 Creating Your Profile...';
                    
                    await fetch(`${API_URL}/users/init?telegram_id=${TELEGRAM_ID}&username=${encodeURIComponent(username)}&first_name=${encodeURIComponent(firstName)}&last_name=${encodeURIComponent(lastName)}`, {
                        method: 'POST'
                    });
                    
                    // Wait a moment for dramatic effect
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                button.innerHTML = '✅ Ready! Starting Game...';
                
                // Mark as participated
                userHasParticipated = true;
                localStorage.setItem('userParticipated_' + TELEGRAM_ID, 'true');
                
                // Fade out welcome screen
                welcomeScreen.style.opacity = '0';
                welcomeScreen.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    welcomeScreen.remove();
                    // Load user data and start the game
                    loadUserData();
                    loadTasks();
                }, 500);
                
            } catch (error) {
                console.error('Error starting participation:', error);
                button.innerHTML = '❌ Error - Try Again';
                button.disabled = false;
            }
        }
        
        // Block access if not from Telegram
        if (!checkTelegramAuth()) {
            throw new Error('Telegram authentication required');
        }
        
        // Check if user has already participated
        const hasParticipated = localStorage.getItem('userParticipated_' + TELEGRAM_ID);
        if (!hasParticipated) {
            // Show welcome screen on first visit
            showWelcomeScreen();
        } else {
            // User has participated before, load game directly
            userHasParticipated = true;
        }
        
        console.log('API_URL configured:', API_URL);
        console.log('Telegram ID:', TELEGRAM_ID);

        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            if (btn) btn.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (tabName === 'leaderboard') loadLeaderboard();
            if (tabName === 'rewards') loadRewards();
            if (tabName === 'profile') loadProfile();
            if (tabName === 'notifications') loadNotifications();
        }

        // Server Status Monitoring
        async function checkServerStatus() {
            const statusIcon = document.getElementById('serverStatus');
            if (!statusIcon) return;
            
            let apiStatus = false;
            let botStatus = false;
            
            // Check API Server
            try {
                const apiResponse = await fetch(`${API_URL}/tasks`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000) // 5 second timeout
                });
                apiStatus = apiResponse.ok;
            } catch (error) {
                console.log('API check failed:', error);
            }
            
            // Check Bot Server (optional - checks if bot endpoint responds)
            try {
                const botResponse = await fetch(`${API_URL}/health`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                botStatus = botResponse.ok;
            } catch (error) {
                // Bot health endpoint might not exist, default to API status
                botStatus = apiStatus;
            }
            
            // Update status indicator
            if (apiStatus && botStatus) {
                // All good - Green
                statusIcon.className = 'p-2 rounded-lg text-green-500';
                statusIcon.title = 'All Systems Operational';
            } else if (apiStatus || botStatus) {
                // Partial - Yellow
                statusIcon.className = 'p-2 rounded-lg text-yellow-500';
                statusIcon.title = 'Some Services Down';
            } else {
                // Down - Red
                statusIcon.className = 'p-2 rounded-lg text-red-500';
                statusIcon.title = 'Server Offline';
            }
        }

        async function loadUserData() {
            try {
                let response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                
                // If user doesn't exist, create them automatically with Telegram data
                if (response.status === 404) {
                    const username = TELEGRAM_USER.username || `player${TELEGRAM_ID}`;
                    const firstName = TELEGRAM_USER.first_name || 'Player';
                    const lastName = TELEGRAM_USER.last_name || '';
                    
                    await fetch(`${API_URL}/users/init?telegram_id=${TELEGRAM_ID}&username=${encodeURIComponent(username)}&first_name=${encodeURIComponent(firstName)}&last_name=${encodeURIComponent(lastName)}`, {
                        method: 'POST'
                    });
                    response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                }
                
                const user = await response.json();
                document.getElementById('userPoints').textContent = user.points || 0;
                
                // Update profile display with Telegram data
                if (TELEGRAM_USER) {
                    const displayName = TELEGRAM_USER.first_name || user.username || 'Player';
                    document.getElementById('profileUsername').textContent = displayName;
                }
            } catch (error) {
                console.error('Error loading user:', error);
                document.getElementById('userPoints').textContent = '---';
            }
        }

        // Track current category filter
        let currentQuestCategory = 'all';
        let allTasksData = [];
        let completedTaskIds = new Set();

        // Filter quests by category
        function filterQuestsByCategory(category) {
            currentQuestCategory = category;
            
            // Update tab active states
            document.querySelectorAll('.quest-category-tab').forEach(tab => {
                if (tab.dataset.category === category) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Re-render quest list with filter
            displayFilteredQuests();
        }

        // Get quest status based on state
        function getQuestStatus(task) {
            // Check if completed
            if (completedTaskIds.has(task.id)) {
                return { status: 'completed', emoji: '✅', label: 'Completed' };
            }
            
            // Check if in progress (has start time in localStorage)
            const startTime = localStorage.getItem(`quest_start_${task.id}`);
            if (startTime) {
                return { status: 'in-progress', emoji: '🟡', label: 'In Progress' };
            }
            
            // Default: available
            return { status: 'available', emoji: '🟢', label: 'Available' };
        }

        // Get quest category
        function getQuestCategory(task) {
            // Check if task has category field
            if (task.category) return task.category;
            
            // Auto-categorize based on platform/type
            if (task.platform === 'telegram' || task.platform === 'twitter' || task.platform === 'instagram') {
                return 'partner';
            }
            
            // Check if daily quest (has daily_reset flag or description mentions daily)
            if (task.daily_reset || task.title?.toLowerCase().includes('daily')) {
                return 'daily';
            }
            
            // Check if special (limited time or high rewards)
            if (task.limited_time || (task.points_reward && task.points_reward >= 1000)) {
                return 'special';
            }
            
            // Default to general
            return 'general';
        }

        // Display filtered quests
        function displayFilteredQuests() {
            const container = document.getElementById('tasksContainer');
            
            // Filter by category
            let filtered = currentQuestCategory === 'all' 
                ? allTasksData 
                : allTasksData.filter(task => getQuestCategory(task) === currentQuestCategory);
            
            // Sort: Incomplete quests first, completed quests last
            filtered.sort((a, b) => {
                const statusA = getQuestStatus(a);
                const statusB = getQuestStatus(b);
                
                const isCompletedA = statusA.status === 'completed';
                const isCompletedB = statusB.status === 'completed';
                
                // If one is completed and the other isn't, incomplete comes first
                if (isCompletedA && !isCompletedB) return 1;  // a goes after b
                if (!isCompletedA && isCompletedB) return -1; // a comes before b
                
                // If both have the same completion status, maintain original order
                return 0;
            });
            
            // Update count
            document.getElementById('tasksCount').textContent = filtered.length;
            
            if (filtered.length === 0) {
                const categoryName = currentQuestCategory === 'all' ? 'quests' : `${currentQuestCategory} quests`;
                container.innerHTML = `<div class="text-center py-12 text-gray-400">No ${categoryName} available right now. Check back later! 🎯</div>`;
                return;
            }
            
            // Render quest cards
            container.innerHTML = filtered.map((task, index) => {
                const platformEmoji = {
                    'youtube': '📺',
                    'twitter': '🐦',
                    'telegram': '✈️',
                    'discord': '💬',
                    'instagram': '📷'
                }[task.platform] || '🎯';
                
                const platformName = task.platform || 'general';
                const points = task.points_reward || 0;
                const category = getQuestCategory(task);
                const statusInfo = getQuestStatus(task);
                
                // Determine if quest is clickable and get indicator icon
                const isCompleted = statusInfo.status === 'completed';
                const isClickable = !isCompleted;
                
                // TapSwap-style indicator: Green checkmark for completed, Arrow for available
                let indicatorIcon = '';
                let indicatorClass = '';
                if (isCompleted) {
                    indicatorIcon = '✓';
                    indicatorClass = 'text-neon-green text-2xl font-bold';
                } else {
                    indicatorIcon = '›';
                    indicatorClass = 'text-neon-blue text-2xl font-bold';
                }
                
                const cursorClass = isClickable ? 'cursor-pointer' : 'cursor-default';
                const opacityClass = isCompleted ? 'opacity-70' : '';
                const hoverClass = isClickable ? 'hover:border-neon-purple/50 active:scale-95' : '';
                const clickHandler = isClickable ? `onclick="showTaskDetail(${allTasksData.indexOf(task)})"` : '';
                
                return `
                    <div class="bg-gaming-dark/80 rounded-xl p-4 border border-neon-blue/30 ${hoverClass} transition-all ${cursorClass} ${opacityClass}" ${clickHandler}>
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-neon-blue/10 rounded-xl border border-neon-blue/20">
                                <span class="text-2xl">${platformEmoji}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-sm mb-1 truncate">${task.title}</h3>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm font-black text-neon-green flex items-center">
                                        <span class="text-yellow-400 mr-1">●</span> ${points}
                                    </span>
                                </div>
                            </div>
                            <div class="flex-shrink-0 ${indicatorClass}">
                                ${indicatorIcon}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/tasks`);
                const allTasks = await response.json();
                
                // Get user's completed tasks
                completedTaskIds = new Set();
                if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                    try {
                        const telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
                        const userTasksResponse = await fetch(`${API_URL}/users/${telegramId}/tasks`);
                        const userTasks = await userTasksResponse.json();
                        
                        // Get IDs of completed tasks
                        completedTaskIds = new Set(
                            userTasks
                                .filter(ut => ut.status === 'completed')
                                .map(ut => ut.task_id)
                        );
                    } catch (e) {
                        console.log('Could not fetch user tasks:', e);
                    }
                }
                
                // DON'T filter out completed tasks - show ALL tasks
                // Completed tasks will show with checkmark, available tasks with arrow
                allTasksData = allTasks;
                
                // Store tasks globally for access
                window.tasksData = allTasksData;
                
                // Display with current filter
                displayFilteredQuests();
                
            } catch (error) {
                console.error(error);
                const container = document.getElementById('tasksContainer');
                container.innerHTML = '<div class="text-center py-12 text-red-400">⚠️ Failed to load quests. Please try again.</div>';
            }
        }

        async function loadLeaderboard(forceRefresh = false) {
            const container = document.getElementById('leaderboardContainer');
            
            try {
                // Check cache (unless force refresh)
                const now = Date.now();
                if (!forceRefresh && leaderboardCache && (now - leaderboardCacheTime) < LEADERBOARD_CACHE_DURATION) {
                    console.log('Using cached leaderboard data');
                    displayLeaderboard(leaderboardCache);
                    return;
                }
                
                // Show loading state
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="animate-spin text-4xl mb-2">⚡</div>
                        <div>Loading rankings...</div>
                    </div>
                `;
                
                const response = await fetch(`${API_URL}/leaderboard?limit=20`);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const leaders = await response.json();
                
                // Update cache
                leaderboardCache = leaders;
                leaderboardCacheTime = now;
                
                // Display leaderboard
                displayLeaderboard(leaders);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                container.innerHTML = `
                    <div class="text-center py-12 text-red-400">
                        <div class="text-5xl mb-3">⚠️</div>
                        <div class="text-lg font-bold mb-1">Failed to Load Rankings</div>
                        <div class="text-sm mb-4">${error.message || 'Please try again later'}</div>
                        <button onclick="loadLeaderboard(true)" class="px-4 py-2 bg-neon-blue/20 hover:bg-neon-blue/30 border border-neon-blue rounded-lg transition-all">
                            🔄 Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function displayLeaderboard(leaders) {
            const container = document.getElementById('leaderboardContainer');
            
            // Check if leaderboard is empty
            if (!leaders || leaders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-5xl mb-3">🏆</div>
                        <div class="text-lg font-bold mb-1">No Players Yet</div>
                        <div class="text-sm">Complete quests to be the first on the leaderboard!</div>
                    </div>
                `;
                return;
            }
            
            // Display leaderboard
            container.innerHTML = leaders.map((user, i) => {
                const rank = i + 1;
                const rankDisplay = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : `#${rank}`;
                const isCurrentUser = user.telegram_id === TELEGRAM_ID;
                const highlightClass = isCurrentUser ? 'border-brand-gold/50 bg-brand-gold/5' : 'border-neon-blue/30';
                
                return `
                    <div class="bg-gaming-darker/50 rounded-xl p-3 border ${highlightClass} flex items-center gap-3 hover:bg-gaming-darker/70 transition-all">
                        <div class="text-xl font-black w-10 text-center ${i < 3 ? 'text-2xl' : ''}">${rankDisplay}</div>
                        <div class="flex-1">
                            <div class="font-bold text-sm ${isCurrentUser ? 'text-brand-gold' : ''}">${user.username || 'Player'} ${isCurrentUser ? '(You)' : ''}</div>
                            <div class="text-xs text-gray-400">${user.completed_tasks || 0} quests completed</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-black text-neon-green">${user.points}</div>
                            <div class="text-xs text-gray-500">XP</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadRewards() {
            try {
                const response = await fetch(`${API_URL}/rewards`);
                const rewards = await response.json();
                const container = document.getElementById('rewardsContainer');
                
                container.innerHTML = rewards.map(reward => `
                    <div class="bg-gaming-dark/80 rounded-xl p-4 border border-neon-purple/30">
                        <div class="flex items-start gap-3">
                            <div class="text-3xl">💎</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-sm mb-1">${reward.title}</h3>
                                <p class="text-xs text-gray-400 mb-2">${reward.description || ''}</p>
                                <div class="flex justify-between">
                                    <span class="text-xs text-gray-400">${reward.quantity_available || 0} left</span>
                                    <span class="text-sm font-black text-neon-pink">${reward.points_cost || 0} XP</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error(error);
            }
        }

        // Store user activities globally
        let userActivities = [];
        let currentActivityFilter = 'all';
        
        // Cache leaderboard data to avoid repeated API calls
        let leaderboardCache = null;
        let leaderboardCacheTime = 0;
        const LEADERBOARD_CACHE_DURATION = 30000; // 30 seconds

        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                const user = await response.json();
                const level = Math.floor(user.points / 100) + 1;
                
                document.getElementById('profileUsername').textContent = user.username || 'Player';
                document.getElementById('profileLevel').textContent = level;
                document.getElementById('profileXP').textContent = user.points;
                
                // Load quest activity first to get completed count
                await loadUserActivity();
                
                // Calculate completed quests from activity
                const completedCount = userActivities.filter(t => t.status === 'completed').length;
                document.getElementById('profileQuests').textContent = completedCount;
                
                // Load and calculate rank from leaderboard
                await loadUserRank(user.telegram_id, user.points);
            } catch (error) {
                console.error(error);
            }
        }

        async function loadUserRank(telegramId, userPoints) {
            try {
                // Fetch leaderboard (top 100 to find user rank)
                const response = await fetch(`${API_URL}/leaderboard?limit=100`);
                const leaderboard = await response.json();
                
                // Find user's rank
                const userRank = leaderboard.findIndex(u => u.telegram_id === telegramId) + 1;
                
                if (userRank > 0) {
                    document.getElementById('profileRank').textContent = `#${userRank}`;
                } else {
                    // User not in top 100, estimate rank
                    const usersAbove = leaderboard.filter(u => u.points > userPoints).length;
                    if (usersAbove === 100) {
                        document.getElementById('profileRank').textContent = '100+';
                    } else {
                        document.getElementById('profileRank').textContent = `#${usersAbove + 1}`;
                    }
                }
            } catch (error) {
                console.error('Error loading rank:', error);
                document.getElementById('profileRank').textContent = '-';
            }
        }

        async function loadUserActivity() {
            try {
                // Fetch user's task history
                const response = await fetch(`${API_URL}/users/${TELEGRAM_ID}/tasks`);
                const userTasks = await response.json();
                
                // Store activities
                userActivities = userTasks || [];
                
                // Calculate stats
                const successCount = userActivities.filter(t => t.status === 'completed').length;
                const failedCount = userActivities.filter(t => t.status === 'rejected').length;
                const totalAttempts = successCount + failedCount;
                const successRate = totalAttempts > 0 ? Math.round((successCount / totalAttempts) * 100) : 0;
                
                // Update stats display
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failedCount').textContent = failedCount;
                document.getElementById('successRate').textContent = successRate + '%';
                
                // Display activities
                displayActivities();
            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('activityContainer').innerHTML = `
                    <div class="text-center py-8 text-red-400 text-sm">
                        <div class="text-4xl mb-2">⚠️</div>
                        <div>Could not load activity</div>
                    </div>
                `;
            }
        }

        function displayActivities() {
            const container = document.getElementById('activityContainer');
            
            // Filter activities based on current filter
            let filteredActivities = userActivities;
            if (currentActivityFilter === 'success') {
                filteredActivities = userActivities.filter(t => t.status === 'completed');
            } else if (currentActivityFilter === 'failed') {
                filteredActivities = userActivities.filter(t => t.status === 'rejected');
            }
            
            // Sort by date (newest first)
            filteredActivities.sort((a, b) => new Date(b.completed_at || b.updated_at) - new Date(a.completed_at || a.updated_at));
            
            if (filteredActivities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 text-sm">
                        <div class="text-4xl mb-2">🎯</div>
                        <div>${currentActivityFilter === 'all' ? 'Complete quests to see your activity!' : 'No ' + currentActivityFilter + ' quests found'}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredActivities.map(activity => {
                const isSuccess = activity.status === 'completed';
                const isFailed = activity.status === 'rejected';
                const isPending = !isSuccess && !isFailed;
                
                const statusColor = isSuccess ? 'green' : isFailed ? 'red' : 'yellow';
                const statusIcon = isSuccess ? '✅' : isFailed ? '❌' : '⏳';
                const statusText = isSuccess ? 'SUCCESS' : isFailed ? 'FAILED' : 'PENDING';
                
                const date = new Date(activity.completed_at || activity.updated_at);
                const timeAgo = getTimeAgo(date);
                
                // Get XP - use points_earned if available, otherwise 0
                const xpEarned = activity.points_earned || 0;
                const points = isSuccess ? `+${xpEarned} XP` : isFailed ? '0 XP' : '...';
                
                return `
                    <div class="bg-gaming-darker/50 rounded-lg p-2.5 border-l-4 border-${statusColor}-500/50 hover:bg-gaming-darker/70 transition-all">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">${statusIcon}</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="text-sm font-bold">${activity.task_title || 'Quest'}</div>
                                    <div class="text-xs font-black ${isSuccess ? 'text-green-400' : isFailed ? 'text-red-400' : 'text-yellow-400'}">${points}</div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-${statusColor}-500/20 text-${statusColor}-400 font-semibold">${statusText}</span>
                                    <span class="text-xs text-gray-500">${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterActivity(filter) {
            currentActivityFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.activity-filter').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
            
            // Re-display activities
            displayActivities();
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function loadNotifications() {
            const container = document.getElementById('notificationsContainer');
            container.innerHTML = `
                <div class="bg-gaming-darker/50 rounded-lg p-3 border-l-4 border-neon-blue">
                    <div class="flex gap-3">
                        <span class="text-xl">⚔️</span>
                        <div class="flex-1">
                            <div class="text-sm font-bold">Quest Completed!</div>
                            <div class="text-xs text-gray-400">You earned 50 XP</div>
                            <div class="text-xs text-gray-500 mt-1">Just now</div>
                        </div>
                    </div>
                </div>
            `;
        }

        let currentTaskId = null;
        let currentTaskUrl = null;
        let currentTask = null;
        let videoWatchTimer = null;
        let watchTimerInterval = null;
        let videoStartTime = null;
        let requiredWatchTime = 0;

        // Navigation: Back to quest list
        function backToQuestList() {
            // Hide all quest detail pages
            document.getElementById('youtubeQuestPage').classList.add('hidden');
            document.getElementById('regularQuestPage').classList.add('hidden');
            document.getElementById('questDetailPage').classList.add('hidden');
            
            // Show quest list
            document.getElementById('tasks').classList.remove('hidden');
            
            // Clean up any running timers
            if (videoWatchTimer) {
                clearInterval(videoWatchTimer);
                videoWatchTimer = null;
            }
            if (watchTimerInterval) {
                clearInterval(watchTimerInterval);
                watchTimerInterval = null;
            }
            
            // Reset state
            currentTask = null;
            currentTaskId = null;
            currentTaskUrl = null;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Quest state management
        let questState = 'not_started'; // not_started, in_progress, ready_to_claim, completed

        function showTaskDetail(taskIndex) {
            const task = window.tasksData[taskIndex];
            if (!task) return;
            
            // Check if quest is already completed - prevent reopening
            const statusInfo = getQuestStatus(task);
            if (statusInfo.status === 'completed') {
                console.log('⚠️ Quest already completed - cannot reopen');
                
                // Show a toast message
                const toast = document.createElement('div');
                toast.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gaming-darker/95 border-2 border-neon-green text-white px-6 py-4 rounded-xl shadow-2xl z-50 text-center';
                toast.innerHTML = `
                    <div class="text-3xl mb-2">✅</div>
                    <div class="text-lg font-bold">Quest Already Completed!</div>
                    <div class="text-sm text-gray-400 mt-1">You've already earned the rewards</div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                
                return; // Don't open the quest
            }
            
            currentTask = task;
            currentTaskId = task.id;
            currentTaskUrl = task.url;
            questState = 'not_started';
            
            // Hide quest list
            document.getElementById('tasks').classList.add('hidden');
            
            // Show new dynamic quest detail page
            showQuestDetailPage(task);
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function showQuestDetailPage(task) {
            console.log('📄 SHOW QUEST DETAIL PAGE');
            console.log('   Task:', task);
            
            const points = task.points_reward || 0;
            const taskType = task.task_type || '';
            const verificationData = task.verification_data || {};
            
            console.log('   Points:', points);
            console.log('   Task type:', taskType);
            console.log('   Verification data:', verificationData);
            
            // Set basic quest info
            document.getElementById('questTitle').textContent = task.title;
            document.getElementById('questDescription').textContent = task.description || 'Complete this quest to earn rewards';
            
            // Format points with space (TapSwap style)
            const formattedPoints = points.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            document.getElementById('questPoints').textContent = formattedPoints;
            
            // Generate instructions based on task type
            const instructions = generateInstructions(task, taskType, verificationData);
            document.getElementById('questInstructions').innerHTML = instructions;
            
            // Generate dynamic content based on task_type
            console.log('   🔧 Generating dynamic content...');
            const dynamicContent = generateQuestContent(task, taskType, verificationData);
            console.log('   Dynamic content generated:', dynamicContent);
            
            const dynamicContentElement = document.getElementById('questDynamicContent');
            console.log('   Dynamic content container:', dynamicContentElement);
            
            dynamicContentElement.innerHTML = dynamicContent.html;
            console.log('   ✅ Dynamic content HTML inserted');
            
            // Verify the code input section was inserted
            setTimeout(() => {
                const codeInputCheck = document.getElementById('codeInputSection');
                console.log('   🔍 Code input section verification:', codeInputCheck);
                console.log('   Code input section exists:', !!codeInputCheck);
            }, 100);
            
            // Action button is now generated in generateQuestContent(), no need for separate generation
            document.getElementById('questActionButton').innerHTML = '';
            
            // Generate tasks list
            const tasksList = generateTasksList(task, taskType, verificationData);
            document.getElementById('questTasksList').innerHTML = tasksList;
            
            // Show the page
            document.getElementById('questDetailPage').classList.remove('hidden');
            console.log('   ✅ Quest detail page shown');
            
            // Execute any post-render scripts
            if (dynamicContent.onRender) {
                console.log('   🎬 Executing onRender callback...');
                dynamicContent.onRender();
            }
        }

        function generateInstructions(task, taskType, verificationData) {
            let instructions = '';
            
            // YouTube Watch Quest - Compact
            if (taskType === 'youtube' || taskType === 'youtube_watch') {
                instructions = `
                    <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">📺</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-red-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-red-400 font-bold">1.</span> Watch the video at 0:${String(task.min_watch_time_seconds || verificationData.min_watch_time || 30).padStart(2, '0')}</li>
                                    <li class="flex gap-1.5"><span class="text-red-400 font-bold">2.</span> Find the verification code</li>
                                    <li class="flex gap-1.5"><span class="text-red-400 font-bold">3.</span> Enter code & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Twitter Follow
            else if (taskType === 'twitter_follow') {
                instructions = `
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">🐦</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-blue-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-blue-400 font-bold">1.</span> Follow @${verificationData.username || 'BRGYTamago'}</li>
                                    <li class="flex gap-1.5"><span class="text-blue-400 font-bold">2.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Twitter Like
            else if (taskType === 'twitter_like') {
                instructions = `
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">❤️</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-blue-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-blue-400 font-bold">1.</span> Like the tweet</li>
                                    <li class="flex gap-1.5"><span class="text-blue-400 font-bold">2.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Twitter Retweet
            else if (taskType === 'twitter_retweet') {
                instructions = `
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">🔄</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-blue-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-blue-400 font-bold">1.</span> Retweet the post</li>
                                    <li class="flex gap-1.5"><span class="text-blue-400 font-bold">2.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Telegram Join
            else if (taskType.startsWith('telegram_') || taskType === 'telegram' || task.platform === 'telegram') {
                instructions = `
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">✈️</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-cyan-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-cyan-400 font-bold">1.</span> Join the channel/group</li>
                                    <li class="flex gap-1.5"><span class="text-cyan-400 font-bold">2.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Instagram Follow
            else if (task.platform === 'instagram' || taskType.includes('instagram')) {
                instructions = `
                    <div class="bg-pink-500/10 border border-pink-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">📷</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-pink-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-pink-400 font-bold">1.</span> Follow our Instagram</li>
                                    <li class="flex gap-1.5"><span class="text-pink-400 font-bold">2.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Discord Join
            else if (task.platform === 'discord' || taskType.includes('discord')) {
                instructions = `
                    <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">💬</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-indigo-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-indigo-400 font-bold">1.</span> Join Discord server</li>
                                    <li class="flex gap-1.5"><span class="text-indigo-400 font-bold">2.</span> Say "Hi" in general</li>
                                    <li class="flex gap-1.5"><span class="text-indigo-400 font-bold">3.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Daily Check-in
            else if (taskType === 'daily_checkin') {
                instructions = `
                    <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">📅</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-green-400 text-sm mb-1.5">Daily Check-in:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-green-400 font-bold">1.</span> Click to claim daily reward</li>
                                    <li class="flex gap-1.5"><span class="text-green-400 font-bold">2.</span> Come back tomorrow!</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Default
            else {
                instructions = `
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-3 mb-3">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">🎯</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-purple-400 text-sm mb-1.5">How to complete:</h4>
                                <ol class="space-y-1 text-xs text-gray-300">
                                    <li class="flex gap-1.5"><span class="text-purple-400 font-bold">1.</span> Complete required action</li>
                                    <li class="flex gap-1.5"><span class="text-purple-400 font-bold">2.</span> Return & claim reward</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return instructions;
        }

        function generateActionButton(task, taskType) {
            const taskTypeColors = {
                'youtube': 'from-red-600 to-red-700 hover:from-red-700 hover:to-red-800',
                'youtube_watch': 'from-red-600 to-red-700 hover:from-red-700 hover:to-red-800',
                'twitter_follow': 'from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700',
                'twitter_like': 'from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700',
                'twitter_retweet': 'from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700',
                'twitter_reply': 'from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700',
                'telegram_join': 'from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600',
                'instagram': 'from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600',
                'discord': 'from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600',
                'daily_checkin': 'from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600',
                'default': 'from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800'
            };
            
            const colors = taskTypeColors[taskType] || taskTypeColors['default'];
            
            return `
                <button id="questActionBtn" onclick="handleQuestAction()" class="w-full bg-gradient-to-r ${colors} rounded-2xl p-4 font-bold text-lg active:scale-95 transition-all shadow-lg">
                    Start mission
                </button>
            `;
        }

        // Handle quest action based on state (Start → Claim → Complete)
        function handleQuestAction() {
            const btn = document.getElementById('questActionBtn');
            const taskType = currentTask.task_type || '';
            
            if (questState === 'not_started') {
                // Start mission - open URL and change to "ready to claim"
                if (currentTaskUrl) {
                    window.open(currentTaskUrl, '_blank');
                }
                
                // Mark first task as in progress
                updateTaskStatus(0, 'in-progress');
                
                // For YouTube, show timer
                if (taskType === 'youtube' || taskType === 'youtube_watch') {
                    document.getElementById('youtubeTimer')?.classList.remove('hidden');
                    startWatchTimer();
                    btn.disabled = true;
                    btn.textContent = 'Watching...';
                    questState = 'in_progress';
                } else {
                    // For other quests, change button to "Claim" after short delay
                    btn.disabled = true;
                    btn.textContent = 'Verifying...';
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Claim';
                        questState = 'ready_to_claim';
                        updateTaskStatus(0, 'completed');
                    }, 2000);
                }
            }
            else if (questState === 'ready_to_claim') {
                // Claim reward
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block">⏳</span> Claiming...';
                
                // Submit to backend
                claimQuestReward();
            }
        }

        function updateTaskStatus(taskIndex, status) {
            const taskItems = document.querySelectorAll('.task-item');
            if (taskItems[taskIndex]) {
                const statusIcon = taskItems[taskIndex].querySelector('.task-status');
                if (status === 'in-progress') {
                    statusIcon.innerHTML = '<span class="text-yellow-400 text-xl">⏳</span>';
                } else if (status === 'completed') {
                    statusIcon.innerHTML = '<span class="text-green-400 text-xl">✓</span>';
                }
            }
        }

        function claimQuestReward() {
            console.log('🎁 Claiming quest reward...');
            
            // For YouTube quests, need to get the code
            const taskType = currentTask.task_type || '';
            let submitData = {};
            
            if (taskType === 'youtube' || taskType === 'youtube_watch') {
                const code = document.getElementById('verificationCodeInput')?.value.trim();
                if (!code) {
                    alert('Please enter the verification code first!');
                    return;
                }
                submitData.code = code;
                console.log('📝 Submitting code:', code);
            }
            
            submitTaskCompletion(currentTaskId, submitData);
        }

        async function submitTaskCompletion(taskId, data) {
            try {
                console.log('🚀 Submitting task completion...');
                console.log('   Task ID:', taskId);
                console.log('   Data:', data);
                console.log('   API URL:', `${API_URL}/tasks/${taskId}/complete`);
                console.log('   Telegram ID:', TELEGRAM_ID);
                
                const requestBody = {
                    telegram_id: TELEGRAM_ID,
                    ...data
                };
                console.log('   Request body:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(`${API_URL}/tasks/${taskId}/complete`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('📡 Response status:', response.status);
                console.log('   Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Response not OK. Status:', response.status);
                    console.error('   Error text:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('📦 Response data:', result);
                
                if (result.success) {
                    console.log('✅ Task completed successfully!', result);
                    
                    // Add to completed tasks immediately
                    completedTaskIds.add(taskId);
                    console.log('📝 Added task to completedTaskIds:', taskId);
                    
                    // Show success animation
                    showSuccessAnimation(result);
                    
                    // Wait then go back to quest list
                    setTimeout(() => {
                        console.log('🔄 Reloading quest list with completed task...');
                        backToQuestList();
                        // Reload tasks to update the list
                        loadTasks();
                        loadUserData();
                    }, 2000);
                } else {
                    console.error('❌ Verification failed:', result.message);
                    alert(result.message || 'Verification failed. Please try again.');
                    
                    // Re-enable action button if it exists (for non-YouTube quests)
                    const actionBtn = document.getElementById('questActionBtn');
                    if (actionBtn) {
                        actionBtn.disabled = false;
                        actionBtn.textContent = 'Claim';
                    }
                }
            } catch (error) {
                console.error('❌ ❌ Error submitting task:', error);
                console.error('   Error name:', error.name);
                console.error('   Error message:', error.message);
                console.error('   Error stack:', error.stack);
                
                let errorMessage = 'Failed to submit. Please try again.';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '⚠️ Network error: Cannot connect to server. Please check your connection.';
                    console.error('   🔍 Debugging info:');
                    console.error('      API_BASE:', API_BASE);
                    console.error('      API_URL:', API_URL);
                    console.error('      Task ID:', taskId);
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `Server error: ${error.message}`;
                }
                
                alert(errorMessage);
                
                // Re-enable action button if it exists (for non-YouTube quests)
                const actionBtn = document.getElementById('questActionBtn');
                if (actionBtn) {
                    actionBtn.disabled = false;
                    actionBtn.textContent = 'Claim';
                }
            }
        }

        function showSuccessAnimation(result) {
            console.log('🎉 Showing success animation');
            
            // Try to find action button (for non-YouTube quests)
            const btn = document.getElementById('questActionBtn');
            
            if (btn) {
                // Regular quest - update button
                btn.innerHTML = `
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-2xl">🎉</span>
                        <span>+${result.points_awarded || currentTask.points_reward} XP Claimed!</span>
                        <span class="text-2xl">✓</span>
                    </div>
                `;
                btn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-500');
            } else {
                // YouTube quest - create floating success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-6 rounded-2xl shadow-2xl z-50 text-center animate-bounce';
                successMsg.innerHTML = `
                    <div class="text-4xl mb-2">🎉</div>
                    <div class="text-xl font-bold">Quest Complete!</div>
                    <div class="text-lg">+${result.points_awarded || currentTask.points_reward} XP Earned!</div>
                    <div class="text-2xl mt-2">✓</div>
                    <div class="text-sm mt-2 opacity-90">Returning to quest list...</div>
                `;
                document.body.appendChild(successMsg);
                setTimeout(() => successMsg.remove(), 2000);
                
                // Also update the YouTube submit button to show success
                const youtubeBtn = document.getElementById('youtubeSubmitBtn');
                if (youtubeBtn) {
                    youtubeBtn.innerHTML = '<span class="text-2xl">✅</span> <span>Quest Complete!</span>';
                    youtubeBtn.classList.add('bg-green-600');
                }
            }
            
            // Add confetti effect (simple version)
            const confetti = document.createElement('div');
            confetti.className = 'fixed inset-0 pointer-events-none z-50';
            confetti.innerHTML = '🎉'.repeat(20).split('').map((emoji, i) => 
                `<div class="absolute animate-bounce" style="left: ${Math.random() * 100}%; top: -20px; animation-delay: ${i * 0.1}s">${emoji}</div>`
            ).join('');
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 2000);
        }

        function generateQuestContent(task, taskType, verificationData) {
            console.log('📦 GENERATE QUEST CONTENT');
            console.log('   Task type:', taskType);
            console.log('   Verification data:', verificationData);
            
            const platform = task.platform?.toLowerCase() || '';
            
            // YouTube Watch Quest (with timer and code)
            if (taskType === 'youtube' || taskType === 'youtube_watch') {
                console.log('   🎬 Generating YouTube quest content');
                return {
                    html: `
                        <!-- Watch Video Button -->
                        <button id="watchVideoBtn" onclick="startYouTubeQuest()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                            📺 Watch Video
                        </button>
                        
                        <!-- Timer Display - Redesigned Professional & Simple -->
                        <div id="youtubeTimer" class="hidden mb-6">
                            <div id="timerContainer" class="bg-gradient-to-br from-gaming-dark/80 to-gaming-darker/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700/50 shadow-xl transition-all duration-300">
                                <!-- Timer Value -->
                                <div class="flex items-center justify-center gap-4 mb-4">
                                    <div id="timerIconContainer" class="w-12 h-12 rounded-full bg-yellow-500/10 border-2 border-yellow-500/30 flex items-center justify-center transition-all duration-500">
                                        <svg id="timerIcon" class="w-6 h-6 text-yellow-400 transition-all duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-4xl font-bold text-white tracking-tight transition-all duration-500" id="timerCountdown">0:00</div>
                                        <div class="text-xs text-gray-400 uppercase tracking-wider mt-1" id="timerLabel">Remaining</div>
                                    </div>
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="relative">
                                    <div class="w-full h-1.5 bg-gray-800/50 rounded-full overflow-hidden">
                                        <div id="timerProgress" class="h-full bg-gradient-to-r from-yellow-400 via-yellow-500 to-green-500 transition-all duration-500 ease-out" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Status Text -->
                                <div class="text-center mt-3">
                                    <span class="text-xs text-gray-400 font-medium" id="timerStatus">Keep watching...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Code Input Section (ALWAYS VISIBLE) -->
                        <div id="codeInputSection" class="mb-4">
                            <div class="bg-gaming-dark/60 border border-yellow-500/20 rounded-2xl p-4">
                                <div class="text-center mb-3">
                                    <p class="text-xs text-gray-400" id="codeInputHint">⏱️ Wait for timer to complete before submitting</p>
                                </div>
                                <div class="bg-gaming-darker/60 rounded-xl p-4">
                                    <label class="block text-sm font-bold text-gray-300 mb-2">Enter Verification Code:</label>
                                    <input type="text" id="verificationCodeInput" placeholder="Enter the code from video" class="w-full bg-gaming-darker/80 border-2 border-yellow-500/50 rounded-xl px-4 py-3 text-center font-bold text-lg tracking-wider placeholder-gray-500 focus:outline-none focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/30 transition-all mb-3">
                                    <button id="youtubeSubmitBtn" onclick="handleYouTubeCodeSubmit()" disabled class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-xl p-3 font-bold active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        Submit Code & Claim Reward
                                    </button>
                                </div>
                            </div>
                        </div>
                    `,
                    onRender: () => {
                        // Check task's top-level column first, then verification_data, then default
                        const taskWatchTime = currentTask?.min_watch_time_seconds;
                        const verificationWatchTime = verificationData.min_watch_time || verificationData.min_watch_time_seconds;
                        const defaultTime = taskWatchTime || verificationWatchTime || 30;
                        requiredWatchTime = defaultTime; // Always use database value
                        console.log('   ✅ YouTube content rendered, watch time set to:', requiredWatchTime, 'seconds');
                        console.log('   📊 Source: task.min_watch_time_seconds =', taskWatchTime, ', verification_data =', verificationWatchTime);
                        
                        // Set initial timer display
                        const timerCountdown = document.getElementById('timerCountdown');
                        if (timerCountdown) {
                            const minutes = Math.floor(requiredWatchTime / 60);
                            const seconds = requiredWatchTime % 60;
                            timerCountdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                            console.log('   ✅ Initial timer display set to:', timerCountdown.textContent);
                        }
                    }
                };
            }
            
            // Twitter Quests
            else if (taskType.startsWith('twitter_') || taskType === 'twitter' || platform === 'twitter') {
                const verificationMethod = verificationData.method || 'manual';
                const actionType = verificationData.action_type || 'follow';
                
                const actionText = {
                    'follow': '🐦 Follow on Twitter',
                    'like': '❤️ Like Tweet',
                    'retweet': '🔄 Retweet',
                    'quote': '💬 Quote Tweet',
                    'reply': '💬 Reply to Tweet',
                    'combo': '⭐ Complete Twitter Actions'
                }[actionType] || '🐦 Open Twitter';
                
                // API Verification - Auto check
                if (verificationMethod === 'api') {
                    return {
                        html: `
                            <!-- Open Twitter Button -->
                            <button id="twitterActionBtn" onclick="openTwitterAndPrepareVerification()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                                ${actionText}
                            </button>
                            
                            <!-- Twitter Username Input (Hidden Initially) -->
                            <div id="twitterUsernameContainer" class="hidden mb-4">
                                <label for="twitterUsernameInput" class="block text-sm font-semibold text-gray-300 mb-2">
                                    Your Twitter Username
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg">@</span>
                                    <input 
                                        type="text" 
                                        id="twitterUsernameInput" 
                                        placeholder="username" 
                                        class="w-full bg-gray-800/50 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all"
                                        autocomplete="off"
                                        spellcheck="false"
                                    />
                                </div>
                                <p class="text-xs text-gray-400 mt-2">💡 Enter your Twitter username without the @ symbol</p>
                            </div>
                            
                            <!-- Verify Button (Hidden Initially) -->
                            <button id="twitterVerifyBtn" onclick="verifyTwitterAction()" class="hidden w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                                🔍 Verify Action
                            </button>
                            
                            <!-- Verification Status -->
                            <div id="twitterVerificationStatus" class="hidden mb-4"></div>
                            
                            <!-- Claim Button (Hidden Initially) -->
                            <button id="twitterClaimBtn" onclick="handleTwitterClaim()" class="hidden w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                                ✅ Claim Reward
                            </button>
                            
                            <!-- Debug Log Panel (Collapsible) -->
                            <div id="twitterDebugPanel" class="hidden mt-4">
                                <button onclick="toggleTwitterDebugLog()" class="w-full bg-gray-800/50 border border-gray-700 rounded-xl p-3 text-left flex items-center justify-between hover:bg-gray-700/50 transition-all">
                                    <span class="text-sm font-semibold text-gray-300">🔍 Debug Log</span>
                                    <span id="twitterDebugToggle" class="text-gray-400">▼</span>
                                </button>
                                <div id="twitterDebugLogContent" class="hidden mt-2 bg-black/80 border border-gray-700 rounded-xl p-4 max-h-96 overflow-y-auto">
                                    <div id="twitterDebugLogLines" class="font-mono text-xs space-y-1"></div>
                                </div>
                            </div>
                        `
                    };
                }
                // Manual Verification - Submit for review
                else {
                    return {
                        html: `
                            <button onclick="submitQuest()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                                ${actionText}
                            </button>
                        `
                    };
                }
            }
            
            // Telegram Quests
            else if (taskType.startsWith('telegram_') || taskType === 'telegram' || platform === 'telegram') {
                return {
                    html: `
                        <!-- Join Telegram Button -->
                        <button id="telegramJoinBtn" onclick="openTelegramAndPrepareVerification()" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                            ✈️ Join Now
                        </button>
                        
                        <!-- Verify Membership Button (Hidden Initially) -->
                        <button id="telegramVerifyBtn" onclick="verifyTelegramMembership()" class="hidden w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                            🔍 Verify Me
                        </button>
                        
                        <!-- Verification Status -->
                        <div id="telegramVerificationStatus" class="hidden mb-4"></div>
                        
                        <!-- Claim Button (Hidden Initially) -->
                        <button id="telegramClaimBtn" onclick="handleTelegramClaim()" class="hidden w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-2xl p-4 font-bold text-lg active:scale-95 transition-all shadow-lg">
                            ✅ Claim Reward
                        </button>
                    `
                };
            }
            
            // Instagram Quests
            else if (platform === 'instagram' || taskType.includes('instagram')) {
                return {
                    html: `
                        <button onclick="submitQuest()" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                            Follow on Instagram
                        </button>
                    `
                };
            }
            
            // Discord Quests
            else if (platform === 'discord' || taskType.includes('discord')) {
                return {
                    html: `
                        <button onclick="submitQuest()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                            Join Discord
                        </button>
                    `
                };
            }
            
            // Daily Check-in
            else if (taskType === 'daily_checkin') {
                return {
                    html: `
                        <button onclick="submitQuest()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                            ✓ Check In
                        </button>
                    `
                };
            }
            
            // Website Visit Quest with Timer
            else if (taskType === 'visit' || platform === 'website') {
                const isTimerBased = verificationData.method === 'timer_based';
                const timerSeconds = verificationData.timer_seconds || 60;
                
                if (isTimerBased) {
                    return {
                        html: `
                            <!-- Visit Website Button -->
                            <button id="visitWebsiteBtn" onclick="startWebsiteVisit()" class="w-full bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 rounded-2xl p-4 font-bold text-lg mb-4 active:scale-95 transition-all shadow-lg">
                                🔗 Visit Website
                            </button>
                            
                            <!-- Timer Display -->
                            <div id="websiteTimer" class="hidden mb-6">
                                <div id="websiteTimerContainer" class="bg-gradient-to-br from-gaming-dark/80 to-gaming-darker/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700/50 shadow-xl transition-all duration-300">
                                    <!-- Timer Value -->
                                    <div class="flex items-center justify-center gap-4 mb-4">
                                        <div id="websiteTimerIconContainer" class="w-12 h-12 rounded-full bg-green-500/10 border-2 border-green-500/30 flex items-center justify-center transition-all duration-500">
                                            <svg id="websiteTimerIcon" class="w-6 h-6 text-green-400 transition-all duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="text-4xl font-bold text-white tracking-tight transition-all duration-500" id="websiteTimerCountdown">0:00</div>
                                            <div class="text-xs text-gray-400 uppercase tracking-wider mt-1" id="websiteTimerLabel">Time on site</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    <div class="relative">
                                        <div class="w-full h-1.5 bg-gray-800/50 rounded-full overflow-hidden">
                                            <div id="websiteTimerProgress" class="h-full bg-gradient-to-r from-green-400 via-green-500 to-emerald-500 transition-all duration-500 ease-out" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Text -->
                                    <div class="text-center mt-3">
                                        <span class="text-xs text-gray-400 font-medium" id="websiteTimerStatus">Stay on the website...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Claim Button (Initially Hidden) -->
                            <button id="websiteClaimBtn" onclick="submitQuest()" disabled class="hidden w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-2xl p-4 font-bold text-lg active:scale-95 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                Claim Reward
                            </button>
                        `,
                        onRender: () => {
                            console.log('✅ Website timer-based quest rendered, timer:', timerSeconds, 'seconds');
                            window.websiteTimerSeconds = timerSeconds;
                            
                            // Set initial timer display
                            const timerCountdown = document.getElementById('websiteTimerCountdown');
                            if (timerCountdown) {
                                const minutes = Math.floor(timerSeconds / 60);
                                const seconds = timerSeconds % 60;
                                timerCountdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                            }
                        }
                    };
                } else {
                    // Auto-complete (instant) - no timer
                    return {
                        html: `
                            <button onclick="submitQuest()" class="w-full bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                                🔗 Visit Website
                            </button>
                        `
                    };
                }
            }
            
            // Default/Generic Quest
            else {
                return {
                    html: `
                        <button onclick="submitQuest()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 rounded-2xl p-4 font-bold text-lg mb-8 active:scale-95 transition-all shadow-lg">
                            Start mission
                        </button>
                    `
                };
            }
        }

        function generateTasksList(task, taskType, verificationData) {
            let tasks = [];
            
            // YouTube Watch Quest - 2 tasks (simplified - no code input here)
            if (taskType === 'youtube' || taskType === 'youtube_watch') {
                tasks.push({
                    id: 'watch',
                    text: 'Watch the video completely',
                    status: 'pending',
                    locked: false,
                    hasIcon: true
                });
                tasks.push({
                    id: 'submit',
                    text: 'Submit verification code',
                    status: 'pending',
                    locked: true,
                    hasIcon: true
                });
            }
            
            // Twitter Follow
            else if (taskType === 'twitter_follow') {
                tasks.push({
                    id: 'follow',
                    text: `Follow @${verificationData.username || 'BRGYTamago'}`,
                    status: 'pending',
                    locked: false
                });
            }
            
            // Twitter Like
            else if (taskType === 'twitter_like') {
                tasks.push({
                    id: 'like',
                    text: 'Like the tweet',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Twitter Retweet
            else if (taskType === 'twitter_retweet') {
                tasks.push({
                    id: 'retweet',
                    text: 'Retweet the post',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Telegram Join
            else if (taskType.startsWith('telegram_') || taskType === 'telegram' || task.platform === 'telegram') {
                tasks.push({
                    id: 'join',
                    text: 'Join the Telegram chat',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Discord Join
            else if (task.platform === 'discord') {
                tasks.push({
                    id: 'join',
                    text: 'Join our Discord server',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Instagram Follow
            else if (task.platform === 'instagram') {
                tasks.push({
                    id: 'follow',
                    text: 'Follow us on Instagram',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Daily Check-in
            else if (taskType === 'daily_checkin') {
                tasks.push({
                    id: 'checkin',
                    text: 'Complete daily check-in',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Website Visit Quest
            else if (taskType === 'visit' || task.platform === 'website') {
                const timerSeconds = verificationData.timer_seconds || 60;
                const timerMinutes = Math.floor(timerSeconds / 60);
                const timerText = timerMinutes > 0 
                    ? `${timerMinutes} minute${timerMinutes > 1 ? 's' : ''}`
                    : `${timerSeconds} seconds`;
                
                tasks.push({
                    id: 'visit',
                    text: `Visit the website - Spend ${timerText}`,
                    status: 'pending',
                    locked: false
                });
            }
            
            // Default - single task
            else {
                tasks.push({
                    id: 'complete',
                    text: 'Complete the required action',
                    status: 'pending',
                    locked: false
                });
            }
            
            // Render tasks
            return tasks.map(t => `
                <div class="bg-gaming-dark/60 rounded-xl p-4 border border-neon-blue/20 task-item" data-task-id="${t.id}">
                    <div class="relative">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm text-gray-300">${t.text}</p>
                            </div>
                            <div class="ml-3 text-gray-500 task-status">
                                ${t.hasIcon ? '<span class="text-xl">⏳</span>' : '<span class="text-xl">›</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helper function for YouTube quest
        function startYouTubeQuest() {
            console.log('🎥 START YOUTUBE QUEST');
            console.log('Current task URL:', currentTaskUrl);
            console.log('Required watch time:', requiredWatchTime);
            
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
                console.log('✅ Opened video in new tab');
            }
            
            // Hide watch button
            const watchBtn = document.getElementById('watchVideoBtn');
            console.log('Watch button found:', watchBtn);
            if (watchBtn) {
                watchBtn.disabled = true;
                watchBtn.textContent = '⏳ Watching...';
            }
            
            // Show timer
            const timerElement = document.getElementById('youtubeTimer');
            console.log('Timer element found:', timerElement);
            if (timerElement) {
                timerElement.classList.remove('hidden');
                console.log('✅ Timer displayed');
            }
            
            // Mark watch task as in progress
            const watchTask = document.querySelector('[data-task-id="watch"]');
            console.log('Watch task element found:', watchTask);
            if (watchTask) {
                watchTask.querySelector('.task-status').innerHTML = '<span class="text-yellow-400 text-xl">⏳</span>';
            }
            
            // Start timer
            console.log('🚀 Starting timer...');
            startWatchTimer();
        }

        function startWatchTimer() {
            console.log('🎬 START TIMER - Required time:', requiredWatchTime);
            const totalTime = requiredWatchTime || 30;
            let remaining = totalTime; // Start from total time and count DOWN
            
            console.log('📊 Timer config: Starting at', totalTime, 'seconds, counting down to 0');
            
            // Set initial display
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            document.getElementById('timerCountdown').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerProgress').style.width = '0%';
            
            watchTimerInterval = setInterval(() => {
                remaining--;
                const elapsed = totalTime - remaining;
                const progress = (elapsed / totalTime) * 100;
                
                // Update UI - show remaining time
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('timerCountdown').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timerProgress').style.width = `${progress}%`;
                
                if (remaining % 5 === 0 || remaining <= 5) {
                    console.log(`⏱️ Timer: ${remaining} seconds remaining (${elapsed}/${totalTime} elapsed)`);
                }
                
                if (remaining <= 0) {
                    console.log('✅✅✅ TIMER REACHED 0:00! ✅✅✅');
                    console.log('Clearing interval and triggering unlock...');
                    clearInterval(watchTimerInterval);
                    watchTimerInterval = null;
                    
                    // Add visual alert
                    addDebugLog('⏱️ TIMER COMPLETE - Starting unlock sequence', 'warn');
                    
                    // Trigger completion animations
                    triggerTimerCompleteAnimation();
                    
                    // Call unlock immediately (remove delay)
                    console.log('Calling unlockCodeInput NOW...');
                    unlockCodeInput();
                    
                    // ALSO try with a small delay to ensure DOM is ready
                    setTimeout(() => {
                        console.log('🔄 SECOND UNLOCK ATTEMPT (ensuring DOM is ready)...');
                        const btn = document.getElementById('youtubeSubmitBtn');
                        if (btn && btn.hasAttribute('disabled')) {
                            console.log('   ⚠️ Button still has disabled attribute! Forcing again...');
                            btn.disabled = false;
                            btn.removeAttribute('disabled');
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                            btn.style.pointerEvents = 'auto';
                        } else if (btn) {
                            console.log('   ✅ Button is correctly enabled (no disabled attribute)');
                        }
                    }, 100);
                }
            }, 1000);
        }
        
        function triggerTimerCompleteAnimation() {
            // Get timer elements
            const timerCountdown = document.getElementById('timerCountdown');
            const timerContainer = document.getElementById('timerContainer');
            const timerIconContainer = document.getElementById('timerIconContainer');
            const timerIcon = document.getElementById('timerIcon');
            const timerLabel = document.getElementById('timerLabel');
            const progressBar = document.getElementById('timerProgress');
            
            // Animate countdown number
            if (timerCountdown) {
                timerCountdown.classList.add('timer-complete-animation');
                timerCountdown.style.color = '#22c55e'; // green-500
            }
            
            // Animate and change icon to checkmark
            if (timerIconContainer) {
                timerIconContainer.style.background = 'rgba(34, 197, 94, 0.2)';
                timerIconContainer.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                timerIconContainer.classList.add('timer-complete-animation');
            }
            
            if (timerIcon) {
                // Change to checkmark icon
                setTimeout(() => {
                    timerIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                    timerIcon.style.color = '#22c55e';
                }, 200);
            }
            
            // Update label with animation
            if (timerLabel) {
                setTimeout(() => {
                    timerLabel.textContent = 'Complete!';
                    timerLabel.style.color = '#22c55e';
                    timerLabel.classList.add('slide-up-animation');
                }, 300);
            }
            
            // Add glow effect to container
            if (timerContainer) {
                timerContainer.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                timerContainer.classList.add('success-glow-animation');
            }
            
            // Ensure progress bar is at 100% with green color
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.style.background = 'linear-gradient(to right, #22c55e, #16a34a)';
            }
        }

        function unlockCodeInput() {
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('🔓 UNLOCK CODE INPUT CALLED');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            
            // Add visual debug notification
            addDebugLog('🔓 Timer complete - unlocking submit button', 'info');
            
            // Mark watch task as complete
            const watchTask = document.querySelector('[data-task-id="watch"]');
            console.log('1️⃣ Watch task element:', watchTask);
            if (watchTask) {
                watchTask.querySelector('.task-status').innerHTML = '<span class="text-green-400 text-xl">✓</span>';
                console.log('   ✅ Watch task marked complete');
            }
            
            // Unlock submit task
            const submitTask = document.querySelector('[data-task-id="submit"]');
            console.log('2️⃣ Submit task element:', submitTask);
            if (submitTask) {
                const lockOverlay = submitTask.querySelector('.task-lock');
                console.log('   Lock overlay:', lockOverlay);
                if (lockOverlay) {
                    lockOverlay.remove();
                    console.log('   ✅ Lock overlay removed');
                }
                
                submitTask.querySelector('.task-status').innerHTML = '<span class="text-blue-400 text-xl">›</span>';
                console.log('   ✅ Submit task unlocked');
            }
            
            // Enable submit button (code input section is always visible)
            console.log('3️⃣ Enabling submit button...');
            const submitBtn = document.getElementById('youtubeSubmitBtn');
            const codeInputHint = document.getElementById('codeInputHint');
            
            console.log('   Submit button:', submitBtn);
            console.log('   Button found:', !!submitBtn);
            console.log('   Button disabled before:', submitBtn?.disabled);
            console.log('   Hint element:', codeInputHint);
            
            if (submitBtn) {
                console.log('   📍 BEFORE UNLOCK:');
                console.log('      disabled property:', submitBtn.disabled);
                console.log('      disabled attribute:', submitBtn.getAttribute('disabled'));
                console.log('      hasAttribute:', submitBtn.hasAttribute('disabled'));
                
                // FORCE enable the button - CRITICAL FIX for disabled="" issue
                // Set property first
                submitBtn.disabled = false;
                
                // Remove the attribute (this is KEY for disabled="" bug)
                submitBtn.removeAttribute('disabled');
                
                // Remove all Tailwind disabled classes
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'disabled');
                submitBtn.classList.add('cursor-pointer');
                
                // Force inline styles to override everything
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.style.pointerEvents = 'auto';
                submitBtn.style.filter = 'none'; // Remove any grayscale
                
                // Change button text to show it's ready
                submitBtn.innerHTML = '<span class="text-2xl">✅</span> <span>Submit Code & Claim Reward</span>';
                
                console.log('   📍 AFTER UNLOCK:');
                console.log('      disabled property:', submitBtn.disabled);
                console.log('      disabled attribute:', submitBtn.getAttribute('disabled'));
                console.log('      hasAttribute:', submitBtn.hasAttribute('disabled'));
                console.log('      Button classes:', submitBtn.className);
                console.log('      Button outerHTML:', submitBtn.outerHTML);
                
                // Add a mutation observer to catch if something re-disables it
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
                            console.error('⚠️ WARNING: Something tried to re-disable the button!');
                            console.error('   Forcing it enabled again...');
                            submitBtn.disabled = false;
                            submitBtn.removeAttribute('disabled');
                        }
                    });
                });
                observer.observe(submitBtn, { attributes: true, attributeFilter: ['disabled'] });
                
                console.log('   ✅ Submit button enabled');
                console.log('   🎯 Button should now be FULLY CLICKABLE - disabled attribute REMOVED');
                console.log('   🔍 Mutation observer added to prevent re-disabling');
            } else {
                console.error('   ❌ Submit button NOT FOUND!');
                console.error('   Searched for ID: youtubeSubmitBtn');
            }
            
            if (codeInputHint) {
                codeInputHint.textContent = '✅ Timer complete! You can now submit.';
                codeInputHint.className = 'text-xs text-green-400 font-bold';
                console.log('   ✅ Hint text updated');
            } else {
                console.error('   ❌ Hint element NOT FOUND!');
            }
            
            // Update timer status - professional style
            const timerStatusElement = document.getElementById('timerStatus');
            if (timerStatusElement) {
                timerStatusElement.innerHTML = '<span class="inline-flex items-center gap-1.5"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Complete!</span>';
                timerStatusElement.className = 'text-xs text-green-400 font-semibold';
            }
            
            // Update timer countdown display
            const timerCountdown = document.getElementById('timerCountdown');
            if (timerCountdown) {
                timerCountdown.className = 'text-4xl font-bold text-green-400 tracking-tight';
            }
            
            // Focus on input field
            const inputField = document.getElementById('verificationCodeInput');
            console.log('   Input field:', inputField);
            if (inputField) {
                setTimeout(() => {
                    inputField.focus();
                    console.log('   ✅ Input field focused');
                }, 300);
            }
            
            // Hide watch button
            const watchBtn = document.getElementById('watchVideoBtn');
            console.log('4️⃣ Watch button:', watchBtn);
            if (watchBtn) {
                watchBtn.style.display = 'none';
                console.log('   ✅ Watch button hidden');
            }
            
            // Update timer status
            const timerStatus = document.getElementById('timerStatus');
            console.log('5️⃣ Timer status element:', timerStatus);
            if (timerStatus) {
                timerStatus.textContent = '✅ Timer complete!';
                console.log('   ✅ Timer status updated');
            }
            
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('🏁 UNLOCK CODE INPUT FINISHED');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        }

        function handleYouTubeCodeSubmit() {
            const code = document.getElementById('verificationCodeInput').value.trim();
            if (!code) {
                alert('Please enter the verification code from the video!');
                return;
            }
            
            // Mark submit task as complete
            const submitTask = document.querySelector('[data-task-id="submit"]');
            if (submitTask) {
                submitTask.querySelector('.task-status').innerHTML = '<span class="text-green-400 text-xl">✓</span>';
            }
            
            // Submit to backend
            questState = 'ready_to_claim';
            claimQuestReward();
        }

        function submitYouTubeCode() {
            // Alias for backward compatibility
            handleYouTubeCodeSubmit();
        }

        // Website Visit Quest Timer Functions
        let websiteTimerInterval = null;
        
        function startWebsiteVisit() {
            console.log('🔗 START WEBSITE VISIT');
            console.log('Current task URL:', currentTaskUrl);
            console.log('Required time:', window.websiteTimerSeconds);
            
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
                console.log('✅ Opened website in new tab');
            }
            
            // Hide visit button
            const visitBtn = document.getElementById('visitWebsiteBtn');
            if (visitBtn) {
                visitBtn.disabled = true;
                visitBtn.textContent = '⏳ Visiting...';
            }
            
            // Show timer
            const timerElement = document.getElementById('websiteTimer');
            if (timerElement) {
                timerElement.classList.remove('hidden');
                console.log('✅ Timer displayed');
            }
            
            // Mark visit task as in progress
            const visitTask = document.querySelector('[data-task-id="visit"]');
            if (visitTask) {
                visitTask.querySelector('.task-status').innerHTML = '<span class="text-yellow-400 text-xl">⏳</span>';
            }
            
            // Start timer
            console.log('🚀 Starting website timer...');
            startWebsiteTimer();
        }
        
        function startWebsiteTimer() {
            console.log('⏱️ START WEBSITE TIMER - Required time:', window.websiteTimerSeconds);
            const totalTime = window.websiteTimerSeconds || 60;
            let remaining = totalTime;
            
            console.log('📊 Timer config: Starting at', totalTime, 'seconds, counting down to 0');
            
            // Set initial display
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            const timerCountdown = document.getElementById('websiteTimerCountdown');
            if (timerCountdown) {
                timerCountdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Clear any existing interval
            if (websiteTimerInterval) {
                clearInterval(websiteTimerInterval);
            }
            
            websiteTimerInterval = setInterval(() => {
                remaining--;
                
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                const progressPercent = ((totalTime - remaining) / totalTime) * 100;
                
                // Update countdown display
                if (timerCountdown) {
                    timerCountdown.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }
                
                // Update progress bar
                const progressBar = document.getElementById('websiteTimerProgress');
                if (progressBar) {
                    progressBar.style.width = `${progressPercent}%`;
                }
                
                // Update status text based on time remaining
                const statusElement = document.getElementById('websiteTimerStatus');
                if (statusElement) {
                    if (remaining > 30) {
                        statusElement.textContent = 'Stay on the website...';
                    } else if (remaining > 10) {
                        statusElement.textContent = 'Almost there...';
                    } else if (remaining > 0) {
                        statusElement.textContent = 'Few seconds left...';
                    }
                }
                
                // Timer complete
                if (remaining <= 0) {
                    clearInterval(websiteTimerInterval);
                    websiteTimerInterval = null;
                    console.log('✅ Website timer complete!');
                    triggerWebsiteTimerComplete();
                }
            }, 1000);
        }
        
        function triggerWebsiteTimerComplete() {
            console.log('🎉 WEBSITE TIMER COMPLETE');
            
            // Get timer elements
            const timerCountdown = document.getElementById('websiteTimerCountdown');
            const timerContainer = document.getElementById('websiteTimerContainer');
            const timerIconContainer = document.getElementById('websiteTimerIconContainer');
            const timerIcon = document.getElementById('websiteTimerIcon');
            const timerLabel = document.getElementById('websiteTimerLabel');
            const progressBar = document.getElementById('websiteTimerProgress');
            const statusElement = document.getElementById('websiteTimerStatus');
            
            // Animate countdown number
            if (timerCountdown) {
                timerCountdown.classList.add('timer-complete-animation');
                timerCountdown.style.color = '#22c55e'; // green-500
            }
            
            // Animate and change icon to checkmark
            if (timerIconContainer) {
                timerIconContainer.style.background = 'rgba(34, 197, 94, 0.2)';
                timerIconContainer.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                timerIconContainer.classList.add('timer-complete-animation');
            }
            
            if (timerIcon) {
                setTimeout(() => {
                    timerIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                    timerIcon.style.color = '#22c55e';
                }, 200);
            }
            
            // Update label with animation
            if (timerLabel) {
                setTimeout(() => {
                    timerLabel.textContent = 'Complete!';
                    timerLabel.style.color = '#22c55e';
                    timerLabel.classList.add('slide-up-animation');
                }, 300);
            }
            
            // Add glow effect to container
            if (timerContainer) {
                timerContainer.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                timerContainer.classList.add('success-glow-animation');
            }
            
            // Ensure progress bar is at 100%
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.style.background = 'linear-gradient(to right, #22c55e, #16a34a)';
            }
            
            // Update status
            if (statusElement) {
                statusElement.innerHTML = '<span class="inline-flex items-center gap-1.5"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Time complete!</span>';
                statusElement.className = 'text-xs text-green-400 font-semibold';
            }
            
            // Mark visit task as complete
            const visitTask = document.querySelector('[data-task-id="visit"]');
            if (visitTask) {
                visitTask.querySelector('.task-status').innerHTML = '<span class="text-green-400 text-xl">✓</span>';
            }
            
            // Show and enable claim button
            const claimBtn = document.getElementById('websiteClaimBtn');
            if (claimBtn) {
                claimBtn.classList.remove('hidden');
                claimBtn.disabled = false;
                claimBtn.removeAttribute('disabled');
                console.log('✅ Claim button enabled');
            }
            
            // Hide visit button
            const visitBtn = document.getElementById('visitWebsiteBtn');
            if (visitBtn) {
                visitBtn.style.display = 'none';
            }
        }

        // Telegram Quest Functions
        function openTelegramAndPrepareVerification() {
            console.log('✈️ OPEN TELEGRAM GROUP');
            console.log('Task URL:', currentTaskUrl);
            
            // Update button state
            const joinBtn = document.getElementById('telegramJoinBtn');
            if (joinBtn) {
                joinBtn.style.display = 'none';
            }
            
            // Show instructions
            const statusDiv = document.getElementById('telegramVerificationStatus');
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = `
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">👉</div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-cyan-400">Join the group, then come back here</p>
                                <p class="text-xs text-gray-400 mt-1">After joining, click "Verify Membership"</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show verify button immediately
            const verifyBtn = document.getElementById('telegramVerifyBtn');
            if (verifyBtn) {
                verifyBtn.classList.remove('hidden');
            }
            
            // Mark task as in progress
            const telegramTask = document.querySelector('[data-task-id="join"]');
            if (telegramTask) {
                telegramTask.querySelector('.task-status').innerHTML = '<span class="text-yellow-400 text-xl">⏳</span>';
            }
            
            // Open Telegram using the proper method for Telegram Web Apps
            if (currentTaskUrl) {
                try {
                    // Check if Telegram WebApp is available
                    if (window.Telegram?.WebApp) {
                        // Use Telegram WebApp's openTelegramLink to open the group
                        // This keeps the mini app alive in the background
                        window.Telegram.WebApp.openTelegramLink(currentTaskUrl);
                        console.log('✅ Opened Telegram link using WebApp API');
                    } else {
                        // Fallback: open in new window (for testing in browser)
                        window.open(currentTaskUrl, '_blank');
                        console.log('✅ Opened in new window (testing mode)');
                    }
                } catch (error) {
                    console.error('Error opening Telegram link:', error);
                    // Final fallback
                    window.open(currentTaskUrl, '_blank');
                }
            }
        }
        
        function verifyTelegramMembership() {
            console.log('🔍 Verifying Telegram membership...');
            
            const statusDiv = document.getElementById('telegramVerificationStatus');
            const verifyBtn = document.getElementById('telegramVerifyBtn');
            
            // Show loading state
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin">
                                <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-cyan-400">Verifying membership...</p>
                                <p class="text-xs text-gray-400 mt-1">Checking with Telegram Bot API</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (verifyBtn) {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '⏳ Checking...';
            }
            
            // Get Telegram user ID
            const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegram_id');
            
            if (!telegramId) {
                console.error('❌ No Telegram ID found');
                showVerificationError('Could not get your Telegram ID. Please reload the app.');
                return;
            }
            
            console.log('Using Telegram ID:', telegramId);
            console.log('Task ID:', currentTaskId);
            
            // Call backend to verify membership via Telegram Bot API
            fetch(`${API_URL}/tasks/${currentTaskId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    telegram_id: telegramId
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log('Verification result:', result);
                
                if (result.success) {
                    // Membership verified!
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl">✅</div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-green-400">Membership Verified!</p>
                                        <p class="text-xs text-gray-400 mt-1">You have successfully joined the group</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Mark task as complete
                    const telegramTask = document.querySelector('[data-task-id="join"]');
                    if (telegramTask) {
                        telegramTask.querySelector('.task-status').innerHTML = '<span class="text-green-400 text-xl">✓</span>';
                    }
                    
                    // Hide verify button, show claim button
                    if (verifyBtn) {
                        verifyBtn.style.display = 'none';
                    }
                    
                    const claimBtn = document.getElementById('telegramClaimBtn');
                    if (claimBtn) {
                        claimBtn.classList.remove('hidden');
                        // Store the result for claiming
                        window.telegramVerificationResult = result;
                    }
                    
                    console.log('✅ Telegram membership verified!');
                } else {
                    // Verification failed - user hasn't joined yet
                    const errorMessage = result.message || 'Please join the group first, then verify again';
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl">❌</div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-red-400">Not a Member Yet</p>
                                        <p class="text-xs text-gray-400 mt-1">${errorMessage}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (verifyBtn) {
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '🔍 Verify Again';
                    }
                }
            })
            .catch(error => {
                console.error('❌ Verification error:', error);
                showVerificationError('Connection error. Please try again.');
            });
        }
        
        function showVerificationError(message) {
            const statusDiv = document.getElementById('telegramVerificationStatus');
            const verifyBtn = document.getElementById('telegramVerifyBtn');
            
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">⚠️</div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-yellow-400">Error</p>
                                <p class="text-xs text-gray-400 mt-1">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (verifyBtn) {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '🔄 Try Again';
            }
        }
        
        function handleTelegramClaim() {
            console.log('🎁 Claiming Telegram reward...');
            
            const claimBtn = document.getElementById('telegramClaimBtn');
            if (claimBtn) {
                claimBtn.innerHTML = '🎉 Claiming...';
                claimBtn.disabled = true;
            }
            
            // Get the verification result
            const result = window.telegramVerificationResult || {};
            const pointsEarned = result.points_earned || result.new_total || currentTask?.points_reward || 0;
            
            // Show success animation
            setTimeout(() => {
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
                successMsg.innerHTML = `
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white px-8 py-6 rounded-2xl shadow-2xl text-center max-w-sm mx-4 animate-bounce">
                        <div class="text-5xl mb-3">🎉</div>
                        <div class="text-2xl font-bold mb-2">Quest Complete!</div>
                        <div class="text-xl mb-2">+${pointsEarned} Points</div>
                        <div class="text-sm opacity-90 mt-3">Returning to quests...</div>
                    </div>
                `;
                document.body.appendChild(successMsg);
                
                // Return to quest list
                setTimeout(() => {
                    successMsg.remove();
                    backToQuestList();
                    // Reload tasks to show updated status
                    if (typeof loadTasks === 'function') {
                        loadTasks();
                    }
                }, 2000);
            }, 500);
        }
        
        function verifyTelegramMembership() {
            console.log('🔍 Verifying Telegram membership...');
            
            const statusDiv = document.getElementById('telegramVerificationStatus');
            const verifyBtn = document.getElementById('telegramVerifyBtn');
            
            // Show loading state
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin">
                                <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-cyan-400">Verifying membership...</p>
                                <p class="text-xs text-gray-400 mt-1">Checking with Telegram Bot API</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (verifyBtn) {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '⏳ Checking...';
            }
            
            // Get Telegram user ID
            const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegram_id');
            
            if (!telegramId) {
                console.error('❌ No Telegram ID found');
                showVerificationError('Could not get your Telegram ID. Please reload the app.');
                return;
            }
            
            // Call backend to verify membership via Telegram Bot API
            fetch(`${API_URL}/tasks/${currentTaskId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    telegram_id: telegramId
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log('Verification result:', result);
                
                if (result.success) {
                    // Membership verified!
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl">✅</div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-green-400">Membership Verified!</p>
                                        <p class="text-xs text-gray-400 mt-1">You have successfully joined the group</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Mark task as complete
                    const telegramTask = document.querySelector('[data-task-id="join"]');
                    if (telegramTask) {
                        telegramTask.querySelector('.task-status').innerHTML = '<span class="text-green-400 text-xl">✓</span>';
                    }
                    
                    // Hide verify button, show claim button
                    if (verifyBtn) {
                        verifyBtn.style.display = 'none';
                    }
                    
                    const claimBtn = document.getElementById('telegramClaimBtn');
                    if (claimBtn) {
                        claimBtn.classList.remove('hidden');
                        // Store the result for claiming
                        window.telegramVerificationResult = result;
                    }
                    
                    // Hide join button
                    const joinBtn = document.getElementById('telegramJoinBtn');
                    if (joinBtn) {
                        joinBtn.style.display = 'none';
                    }
                    
                    console.log('✅ Telegram membership verified!');
                } else {
                    // Verification failed - user hasn't joined yet
                    const errorMessage = result.message || 'Please join the group first, then verify again';
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl">❌</div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-red-400">Not a Member Yet</p>
                                        <p class="text-xs text-gray-400 mt-1">${errorMessage}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (verifyBtn) {
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '🔍 Verify Again';
                    }
                }
            })
            .catch(error => {
                console.error('❌ Verification error:', error);
                showVerificationError('Connection error. Please try again.');
            });
        }
        
        function showVerificationError(message) {
            const statusDiv = document.getElementById('telegramVerificationStatus');
            const verifyBtn = document.getElementById('telegramVerifyBtn');
            
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">⚠️</div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-yellow-400">Error</p>
                                <p class="text-xs text-gray-400 mt-1">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (verifyBtn) {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '🔄 Try Again';
            }
        }
        
        function handleTelegramClaim() {
            console.log('🎁 Claiming Telegram reward...');
            
            const claimBtn = document.getElementById('telegramClaimBtn');
            if (claimBtn) {
                claimBtn.innerHTML = '🎉 Claiming...';
                claimBtn.disabled = true;
            }
            
            // Get the verification result
            const result = window.telegramVerificationResult || {};
            const pointsEarned = result.points_earned || result.new_total || currentTask?.points_reward || 0;
            
            // Show success animation
            setTimeout(() => {
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
                successMsg.innerHTML = `
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white px-8 py-6 rounded-2xl shadow-2xl text-center max-w-sm mx-4 animate-bounce">
                        <div class="text-5xl mb-3">🎉</div>
                        <div class="text-2xl font-bold mb-2">Quest Complete!</div>
                        <div class="text-xl mb-2">+${pointsEarned} Points</div>
                        <div class="text-sm opacity-90 mt-3">Returning to quests...</div>
                    </div>
                `;
                document.body.appendChild(successMsg);
                
                // Return to quest list
                setTimeout(() => {
                    successMsg.remove();
                    backToQuestList();
                    // Reload tasks to show updated status
                    if (typeof loadTasks === 'function') {
                        loadTasks();
                    }
                }, 2000);
            }, 500);
        }

        // ============ TWITTER QUEST FUNCTIONS ============
        
        function openTwitterAndPrepareVerification() {
            console.log('🐦 Opening Twitter and preparing verification...');
            
            const actionBtn = document.getElementById('twitterActionBtn');
            const usernameContainer = document.getElementById('twitterUsernameContainer');
            const usernameInput = document.getElementById('twitterUsernameInput');
            const verifyBtn = document.getElementById('twitterVerifyBtn');
            const statusDiv = document.getElementById('twitterVerificationStatus');
            
            // Open Twitter URL
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
            }
            
            // Hide action button
            if (actionBtn) {
                actionBtn.style.display = 'none';
            }
            
            // Show username input container
            if (usernameContainer) {
                usernameContainer.classList.remove('hidden');
                usernameContainer.style.display = 'block';
            }
            
            // Pre-fill username from user profile or localStorage
            if (usernameInput) {
                // Try to get from current user data first
                const savedUsername = window.currentUser?.twitter_username || localStorage.getItem('twitter_username');
                if (savedUsername) {
                    usernameInput.value = savedUsername;
                }
                
                // Auto-remove @ symbol as user types
                usernameInput.addEventListener('input', function(e) {
                    let value = e.target.value;
                    // Remove @ symbol if present
                    if (value.startsWith('@')) {
                        value = value.substring(1);
                    }
                    // Only allow alphanumeric and underscore (valid Twitter username format)
                    value = value.replace(/[^a-zA-Z0-9_]/g, '');
                    e.target.value = value;
                });
                
                // Enable verify button when username is entered
                usernameInput.addEventListener('input', function(e) {
                    if (verifyBtn && e.target.value.trim().length > 0) {
                        verifyBtn.classList.remove('hidden');
                        verifyBtn.style.display = 'block';
                    } else if (verifyBtn) {
                        verifyBtn.classList.add('hidden');
                        verifyBtn.style.display = 'none';
                    }
                });
                
                // If already has username, show verify button
                if (savedUsername) {
                    if (verifyBtn) {
                        verifyBtn.classList.remove('hidden');
                        verifyBtn.style.display = 'block';
                    }
                }
            }
            
            // Show instructions
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = `
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">ℹ️</div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-blue-400">Instructions</p>
                                <p class="text-xs text-gray-400 mt-1">1. Complete the action on Twitter<br>2. Enter your Twitter username below<br>3. Click "Verify Action" to confirm</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show debug panel
            initTwitterDebugLog();
        }
        
        // Debug Log Functions
        function initTwitterDebugLog() {
            const debugPanel = document.getElementById('twitterDebugPanel');
            if (debugPanel) {
                debugPanel.classList.remove('hidden');
                clearTwitterDebugLog();
                addTwitterDebugLog('🔍 Debug log initialized', 'info');
            }
        }
        
        function toggleTwitterDebugLog() {
            const content = document.getElementById('twitterDebugLogContent');
            const toggle = document.getElementById('twitterDebugToggle');
            
            if (content && toggle) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    toggle.textContent = '▲';
                } else {
                    content.classList.add('hidden');
                    toggle.textContent = '▼';
                }
            }
        }
        
        function addTwitterDebugLog(message, type = 'info') {
            const logLines = document.getElementById('twitterDebugLogLines');
            if (!logLines) return;
            
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const line = document.createElement('div');
            
            // Color coding based on type
            const colors = {
                'info': 'text-cyan-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'step': 'text-blue-400'
            };
            
            const color = colors[type] || 'text-gray-300';
            
            line.className = `${color}`;
            line.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            
            logLines.appendChild(line);
            
            // Auto-scroll to bottom
            const logContent = document.getElementById('twitterDebugLogContent');
            if (logContent) {
                logContent.scrollTop = logContent.scrollHeight;
            }
            
            // Also log to console
            console.log(message);
        }
        
        function clearTwitterDebugLog() {
            const logLines = document.getElementById('twitterDebugLogLines');
            if (logLines) {
                logLines.innerHTML = '';
            }
        }
        
        function verifyTwitterAction() {
            addTwitterDebugLog('═══════════════════════════════════', 'step');
            addTwitterDebugLog('🔍 STARTING VERIFICATION PROCESS', 'step');
            addTwitterDebugLog('═══════════════════════════════════', 'step');
            
            const statusDiv = document.getElementById('twitterVerificationStatus');
            const verifyBtn = document.getElementById('twitterVerifyBtn');
            const claimBtn = document.getElementById('twitterClaimBtn');
            const usernameInput = document.getElementById('twitterUsernameInput');
            
            addTwitterDebugLog('📋 Step 1: Getting DOM elements', 'step');
            addTwitterDebugLog('   • Status Div: ' + (statusDiv ? '✅ Found' : '❌ Not found'), 'info');
            addTwitterDebugLog('   • Verify Button: ' + (verifyBtn ? '✅ Found' : '❌ Not found'), 'info');
            addTwitterDebugLog('   • Claim Button: ' + (claimBtn ? '✅ Found' : '❌ Not found'), 'info');
            addTwitterDebugLog('   • Username Input: ' + (usernameInput ? '✅ Found' : '❌ Not found'), 'info');
            
            // Get and validate Twitter username
            let twitterUsername = usernameInput?.value?.trim() || '';
            addTwitterDebugLog('📋 Step 2: Getting Twitter username', 'step');
            addTwitterDebugLog('   • Raw value: ' + usernameInput?.value, 'info');
            addTwitterDebugLog('   • Trimmed value: ' + twitterUsername, 'info');
            
            // Remove @ symbol if present
            if (twitterUsername.startsWith('@')) {
                addTwitterDebugLog('   • Removing @ symbol from: ' + twitterUsername, 'info');
                twitterUsername = twitterUsername.substring(1);
                addTwitterDebugLog('   • After removing @: ' + twitterUsername, 'info');
            }
            
            // Validate username
            addTwitterDebugLog('📋 Step 3: Validating username', 'step');
            if (!twitterUsername) {
                addTwitterDebugLog('❌ Validation failed: Username is empty', 'error');
                showTwitterVerificationError('Please enter your Twitter username.');
                return;
            }
            
            // Validate format (alphanumeric and underscore only)
            const isValidFormat = /^[a-zA-Z0-9_]{1,15}$/.test(twitterUsername);
            addTwitterDebugLog('   • Username: ' + twitterUsername, 'info');
            addTwitterDebugLog('   • Length: ' + twitterUsername.length, 'info');
            addTwitterDebugLog('   • Valid format: ' + (isValidFormat ? '✅ Yes' : '❌ No'), isValidFormat ? 'success' : 'error');
            
            if (!isValidFormat) {
                addTwitterDebugLog('❌ Validation failed: Invalid format', 'error');
                showTwitterVerificationError('Invalid Twitter username format. Use only letters, numbers, and underscores (max 15 characters).');
                return;
            }
            
            addTwitterDebugLog('✅ Username validation passed: ' + twitterUsername, 'success');
            
            // Save username to localStorage for future use
            addTwitterDebugLog('📋 Step 4: Saving to localStorage', 'step');
            localStorage.setItem('twitter_username', twitterUsername);
            addTwitterDebugLog('   • Saved to localStorage: ' + twitterUsername, 'success');
            
            // Show loading state
            addTwitterDebugLog('📋 Step 5: Updating UI (loading)', 'step');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin">
                                <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-cyan-400">Checking @${twitterUsername}...</p>
                                <p class="text-xs text-gray-400 mt-1">Verifying your action with Twitter API</p>
                            </div>
                        </div>
                    </div>
                `;
                addTwitterDebugLog('   • Loading animation displayed', 'info');
            }
            
            if (verifyBtn) {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '⏳ Checking...';
                addTwitterDebugLog('   • Verify button disabled', 'info');
            }
            
            // Disable username input during verification
            if (usernameInput) {
                usernameInput.disabled = true;
                addTwitterDebugLog('   • Username input disabled', 'info');
            }
            
            // Get Telegram user ID (we use this as the user identifier)
            addTwitterDebugLog('📋 Step 6: Getting Telegram user ID', 'step');
            const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegram_id');
            addTwitterDebugLog('   • Telegram WebApp: ' + (window.Telegram?.WebApp ? '✅ Available' : '❌ Not available'), 'info');
            addTwitterDebugLog('   • Telegram ID: ' + telegramId, 'info');
            
            if (!telegramId) {
                addTwitterDebugLog('❌ No Telegram ID found', 'error');
                showTwitterVerificationError('Could not get your user ID. Please reload the app.');
                if (usernameInput) usernameInput.disabled = false;
                return;
            }
            
            // Get current task info
            addTwitterDebugLog('📋 Step 7: Getting task information', 'step');
            addTwitterDebugLog('   • Task ID: ' + currentTaskId, 'info');
            addTwitterDebugLog('   • Task URL: ' + currentTaskUrl, 'info');
            addTwitterDebugLog('   • Action Type: ' + (currentTask?.verification_data?.action_type || 'N/A'), 'info');
            addTwitterDebugLog('   • Target Handle: ' + (currentTask?.verification_data?.twitter_handle || 'N/A'), 'info');
            
            // Prepare API request
            const apiUrl = `${API_URL}/tasks/${currentTaskId}/complete`;
            const requestBody = {
                telegram_id: telegramId,
                twitter_username: twitterUsername
            };
            
            addTwitterDebugLog('📋 Step 8: Preparing API request', 'step');
            addTwitterDebugLog('   • API URL: ' + apiUrl, 'info');
            addTwitterDebugLog('   • Method: POST', 'info');
            addTwitterDebugLog('   • Body: ' + JSON.stringify(requestBody), 'info');
            
            addTwitterDebugLog('📋 Step 9: Sending to backend...', 'step');
            addTwitterDebugLog('   ⏳ Waiting for Twitter API response...', 'info');
            
            const startTime = Date.now();
            
            // Call backend to verify Twitter action via Twitter API
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addTwitterDebugLog('📋 Step 10: Received response', 'step');
                addTwitterDebugLog('   • Status: ' + response.status, response.ok ? 'success' : 'error');
                addTwitterDebugLog('   • Duration: ' + duration + 'ms', 'info');
                addTwitterDebugLog('   • Parsing JSON...', 'info');
                
                return response.json();
            })
            .then(result => {
                addTwitterDebugLog('📋 Step 11: Processing result', 'step');
                addTwitterDebugLog('   • Success: ' + result.success, result.success ? 'success' : 'error');
                console.log('   - Success:', result.success);
                console.log('   - Message:', result.message);
                addTwitterDebugLog('   • Message: ' + (result.message || 'N/A'), 'info');
                addTwitterDebugLog('   • Error: ' + (result.error || 'N/A'), 'info');
                addTwitterDebugLog('   • Points Earned: ' + (result.points_earned || 'N/A'), 'info');
                
                if (result.success) {
                    addTwitterDebugLog('═══════════════════════════════════', 'success');
                    addTwitterDebugLog('✅ VERIFICATION SUCCESSFUL!', 'success');
                    addTwitterDebugLog('═══════════════════════════════════', 'success');
                    addTwitterDebugLog('   • @' + twitterUsername + ' completed the action', 'success');
                    
                    const points = result.points_earned || result.new_total || currentTask?.points_reward;
                    addTwitterDebugLog('   • Points to award: ' + points, 'success');
                    
                    // Store result for claim function
                    window.twitterVerificationResult = result;
                    addTwitterDebugLog('   • Result stored in memory', 'info');
                    
                    // Save Twitter username to user profile in backend
                    addTwitterDebugLog('📋 Step 12: Saving to user profile', 'step');
                    saveTwitterUsernameToProfile(twitterUsername, telegramId);
                    
                    // Show success and enable claim button
                    addTwitterDebugLog('📋 Step 13: Updating UI (success)', 'step');
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl">✅</div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-green-400">Action Verified!</p>
                                        <p class="text-xs text-gray-400 mt-1">@${twitterUsername} completed the action. Click "Claim Reward" to get your points.</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        addTwitterDebugLog('   • Success message displayed', 'success');
                    }
                    
                    // Hide username input container and verify button
                    const usernameContainer = document.getElementById('twitterUsernameContainer');
                    if (usernameContainer) {
                        usernameContainer.style.display = 'none';
                        addTwitterDebugLog('   • Username container hidden', 'info');
                    }
                    
                    if (verifyBtn) {
                        verifyBtn.style.display = 'none';
                        addTwitterDebugLog('   • Verify button hidden', 'info');
                    }
                    
                    // Show claim button
                    if (claimBtn) {
                        claimBtn.classList.remove('hidden');
                        claimBtn.style.display = 'block';
                        addTwitterDebugLog('   • Claim button displayed', 'success');
                    }
                    
                    addTwitterDebugLog('✅ Verification complete! Ready to claim reward.', 'success');
                    
                } else {
                    addTwitterDebugLog('═══════════════════════════════════', 'error');
                    addTwitterDebugLog('❌ VERIFICATION FAILED', 'error');
                    addTwitterDebugLog('═══════════════════════════════════', 'error');
                    
                    // Show error - user hasn't completed the action
                    const errorMessage = result.message || result.error || 'Action not completed yet. Please complete the action on Twitter and try again.';
                    addTwitterDebugLog('   • Error: ' + errorMessage, 'error');
                    addTwitterDebugLog('   • @' + twitterUsername + ' has not completed the action', 'error');
                    
                    addTwitterDebugLog('📋 Step 12: Updating UI (error)', 'step');
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="text-2xl">❌</div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-red-400">Action Not Completed</p>
                                        <p class="text-xs text-gray-400 mt-1">@${twitterUsername}: ${errorMessage}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        addTwitterDebugLog('   • Error message displayed', 'error');
                    }
                    
                    // Re-enable username input and verify button for retry
                    addTwitterDebugLog('📋 Step 13: Re-enabling for retry', 'step');
                    if (usernameInput) {
                        usernameInput.disabled = false;
                        addTwitterDebugLog('   • Username input re-enabled', 'info');
                    }
                    
                    if (verifyBtn) {
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '🔍 Verify Again';
                        addTwitterDebugLog('   • Verify button re-enabled', 'info');
                    }
                    
                    addTwitterDebugLog('❌ User can retry after completing action', 'warning');
                }
                
                addTwitterDebugLog('═══════════════════════════════════', 'info');
                addTwitterDebugLog('🔍 VERIFICATION PROCESS ENDED', 'info');
                addTwitterDebugLog('═══════════════════════════════════', 'info');
            })
            .catch(error => {
                addTwitterDebugLog('═══════════════════════════════════', 'error');
                addTwitterDebugLog('❌ NETWORK ERROR', 'error');
                addTwitterDebugLog('═══════════════════════════════════', 'error');
                addTwitterDebugLog('   • Error Type: ' + error.name, 'error');
                addTwitterDebugLog('   • Error Message: ' + error.message, 'error');
                addTwitterDebugLog('   • Possible causes:', 'warning');
                addTwitterDebugLog('     1. Backend server not running', 'warning');
                addTwitterDebugLog('     2. Network connection issue', 'warning');
                addTwitterDebugLog('     3. CORS error', 'warning');
                addTwitterDebugLog('     4. API endpoint not found (404)', 'warning');
                addTwitterDebugLog('     5. Invalid JSON response', 'warning');
                
                // Re-enable input on error
                if (usernameInput) {
                    usernameInput.disabled = false;
                    addTwitterDebugLog('   • Username input re-enabled', 'info');
                }
                
                showTwitterVerificationError('Connection error. Please try again.');
                addTwitterDebugLog('❌ Verification failed at network level', 'error');
            });
        }
        
        // Helper function to save Twitter username to user profile
        function saveTwitterUsernameToProfile(twitterUsername, telegramId) {
            addTwitterDebugLog('💾 Saving username to profile...', 'step');
            addTwitterDebugLog('   • Username: ' + twitterUsername, 'info');
            addTwitterDebugLog('   • Telegram ID: ' + telegramId, 'info');
            addTwitterDebugLog('   • API: PATCH /users/' + telegramId + '/profile', 'info');
            
            const requestBody = { twitter_username: twitterUsername };
            addTwitterDebugLog('   • Sending PATCH request...', 'info');
            
            // Update backend user profile
            fetch(`${API_URL}/users/${telegramId}/profile`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                addTwitterDebugLog('   • Response: ' + response.status + ' ' + (response.ok ? 'OK' : 'ERROR'), response.ok ? 'info' : 'error');
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    addTwitterDebugLog('✅ Username saved to database!', 'success');
                    addTwitterDebugLog('   • Database updated: ' + twitterUsername, 'success');
                    
                    // Update currentUser if exists
                    if (window.currentUser) {
                        window.currentUser.twitter_username = twitterUsername;
                        addTwitterDebugLog('   • window.currentUser updated', 'success');
                    }
                } else {
                    addTwitterDebugLog('⚠️ Failed to save username to database', 'warning');
                    addTwitterDebugLog('   • Reason: ' + (result.message || 'Unknown error'), 'warning');
                    addTwitterDebugLog('   • Note: Username still saved in localStorage', 'info');
                }
            })
            .catch(error => {
                addTwitterDebugLog('❌ Error saving username to database', 'error');
                addTwitterDebugLog('   • Error: ' + error.message, 'error');
                addTwitterDebugLog('   • Note: Username still in localStorage', 'info');
                addTwitterDebugLog('   • Profile may not sync across devices', 'warning');
            });
        }
        
        function showTwitterVerificationError(message) {
            const statusDiv = document.getElementById('twitterVerificationStatus');
            const verifyBtn = document.getElementById('twitterVerifyBtn');
            const usernameInput = document.getElementById('twitterUsernameInput');
            
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">⚠️</div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-yellow-400">Error</p>
                                <p class="text-xs text-gray-400 mt-1">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Re-enable input on error
            if (usernameInput) {
                usernameInput.disabled = false;
            }
            
            if (verifyBtn) {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '🔄 Try Again';
            }
        }
        
        function handleTwitterClaim() {
            console.log('🎁 Claiming Twitter reward...');
            
            const claimBtn = document.getElementById('twitterClaimBtn');
            if (claimBtn) {
                claimBtn.innerHTML = '🎉 Claiming...';
                claimBtn.disabled = true;
            }
            
            // Get the verification result
            const result = window.twitterVerificationResult || {};
            const pointsEarned = result.points_earned || result.new_total || currentTask?.points_reward || 0;
            
            // Show success animation
            setTimeout(() => {
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
                successMsg.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 text-white px-8 py-6 rounded-2xl shadow-2xl text-center max-w-sm mx-4 animate-bounce">
                        <div class="text-5xl mb-3">🎉</div>
                        <div class="text-2xl font-bold mb-2">Quest Complete!</div>
                        <div class="text-xl mb-2">+${pointsEarned} Points</div>
                        <div class="text-sm opacity-90 mt-3">Congratulations! Returning to quests...</div>
                    </div>
                `;
                document.body.appendChild(successMsg);
                
                // Return to quest list
                setTimeout(() => {
                    successMsg.remove();
                    backToQuestList();
                    // Reload tasks to show updated status
                    if (typeof loadTasks === 'function') {
                        loadTasks();
                    }
                }, 2000);
            }, 500);
        }

        // ============ GENERAL QUEST FUNCTIONS ============

        function submitQuest() {
            // Open the quest URL
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
            }
            
            // Mark task as in progress
            const firstTask = document.querySelector('.task-item');
            if (firstTask) {
                firstTask.querySelector('.task-status').innerHTML = '<span class="text-yellow-400 text-xl">⏳</span>';
            }
            
            // Auto-verify after short delay
            setTimeout(() => {
                submitTaskCompletion(currentTaskId, {});
            }, 2000);
        }

        function showYouTubeQuestPage(task, platformEmoji, platformName, points, verificationData) {
            // Set quest info - TapSwap style
            document.getElementById('ytQuestTitle').textContent = task.title;
            document.getElementById('ytQuestDescription').textContent = task.description || 'Watch the video and find the secret code!';
            
            // Format points with space (TapSwap style: "5 000" instead of "5000")
            const formattedPoints = points.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            document.getElementById('ytQuestPoints').textContent = formattedPoints;
            
            // Get watch time from task - check top-level column first, then verification_data
            const taskWatchTime = task?.min_watch_time_seconds;
            const verificationWatchTime = verificationData?.min_watch_time || verificationData?.min_watch_time_seconds;
            const watchTime = taskWatchTime || verificationWatchTime || 30;
            
            // Set initial timer display to show the required watch time
            const initialMinutes = Math.floor(watchTime / 60);
            const initialSeconds = watchTime % 60;
            document.getElementById('ytTimerCountdown').textContent = 
                `${initialMinutes}:${initialSeconds.toString().padStart(2, '0')}`;
            
            // Reset timer display - hide it initially
            const timerDisplay = document.getElementById('ytTimerDisplay');
            timerDisplay.classList.add('hidden');
            timerDisplay.style.display = 'none';
            
            // Reset and lock code input
            const codeLockOverlay = document.getElementById('ytCodeLockOverlay');
            const verificationCodeInput = document.getElementById('ytVerificationCode');
            const submitButton = document.getElementById('ytSubmitButton');
            
            // HIDE lock overlay - code input always visible
            codeLockOverlay.classList.add('hidden');
            codeLockOverlay.style.display = 'none';
            
            // Enable code input
            verificationCodeInput.value = '';
            verificationCodeInput.disabled = false;
            verificationCodeInput.setAttribute('placeholder', 'Enter the code from video');
            document.getElementById('ytCodeInputHint').innerHTML = '⏱️ Wait for timer to complete before submitting';
            
            // DISABLE submit button until timer completes
            submitButton.disabled = true;
            submitButton.innerHTML = '<span id="ytSubmitButtonText">Submit Code & Claim Reward</span>';
            
            // Show YouTube Quest Page - need to override inline style
            const youtubePage = document.getElementById('youtubeQuestPage');
            youtubePage.classList.remove('hidden');
            youtubePage.style.display = 'block'; // Override the !important inline style
        }

        function showRegularQuestPage(task, platformEmoji, platformName, points) {
            // Set quest info - TapSwap style
            document.getElementById('regQuestTitle').textContent = task.title;
            document.getElementById('regQuestDescription').textContent = task.description || 'Complete this quest to earn points!';
            
            // Format points with space (TapSwap style: "1 000" instead of "1000")
            const formattedPoints = points.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            document.getElementById('regQuestPoints').textContent = formattedPoints;
            
            // Set button text
            const platformButtons = {
                'twitter': 'Follow on Twitter',
                'telegram': 'Join Now',
                'discord': 'Join Discord',
                'instagram': 'Follow on Instagram'
            };
            
            const buttonText = platformButtons[task.platform] || 'Start mission';
            document.getElementById('regQuestButtonText').textContent = buttonText;
            
            // Set task description
            const taskDescriptions = {
                'twitter': 'Follow our Twitter account',
                'telegram': 'Join the Telegram chat',
                'discord': 'Join our Discord server',
                'instagram': 'Follow us on Instagram'
            };
            
            const taskDesc = taskDescriptions[task.platform] || 'Complete the required action';
            document.getElementById('regTaskDescription').textContent = taskDesc;
            
            // Show Regular Quest Page
            document.getElementById('regularQuestPage').classList.remove('hidden');
        }

        function openYouTubeVideo() {
            // Open the video in a new tab
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
            }
            
            // Get minimum watch time from task - check top-level column first, then verification_data
            const taskWatchTime = currentTask?.min_watch_time_seconds;
            const verificationData = currentTask?.verification_data || {};
            const verificationWatchTime = verificationData.min_watch_time || verificationData.min_watch_time_seconds;
            requiredWatchTime = taskWatchTime || verificationWatchTime || 30;
            
            console.log('🎬 Starting YouTube quest timer:');
            console.log('   - task.min_watch_time_seconds:', taskWatchTime);
            console.log('   - verification_data.min_watch_time:', verificationWatchTime);
            console.log('   - Final watch time:', requiredWatchTime, 'seconds');
            
            // Get UI elements
            const timerDisplay = document.getElementById('ytTimerDisplay');
            const codeLockOverlay = document.getElementById('ytCodeLockOverlay');
            const verificationCodeInput = document.getElementById('ytVerificationCode');
            const submitButton = document.getElementById('ytSubmitButton');
            
            // Show timer if there's a minimum watch time
            if (requiredWatchTime > 0) {
                // Show timer display - remove hidden class AND set display style
                timerDisplay.classList.remove('hidden');
                timerDisplay.style.display = 'block';
                
                console.log('✅ Timer display shown - requiredWatchTime:', requiredWatchTime, 'seconds');
                
                // Keep code input ENABLED - hide lock overlay
                codeLockOverlay.classList.add('hidden');
                codeLockOverlay.style.display = 'none';
                verificationCodeInput.disabled = false;
                verificationCodeInput.setAttribute('placeholder', 'Enter the code from video');
                document.getElementById('ytCodeInputHint').innerHTML = '⏱️ Wait for timer to complete before submitting';
                
                // DISABLE submit button until timer completes
                submitButton.disabled = true;
                submitButton.innerHTML = '<span id="ytSubmitButtonText">Submit Code & Claim Reward</span>';
                
                // Start the timer
                startYouTubeTimer();
            } else {
                // No timer required - enable button immediately
                timerDisplay.classList.add('hidden');
                timerDisplay.style.display = 'none';
                codeLockOverlay.classList.add('hidden');
                codeLockOverlay.style.display = 'none';
                verificationCodeInput.disabled = false;
                verificationCodeInput.setAttribute('placeholder', 'Enter the code from video');
                document.getElementById('ytCodeInputHint').innerHTML = '✅ Enter your code and submit';
                
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.innerHTML = '<span class="text-3xl">✅</span><span>Submit Code & Claim Reward</span>';
                
                // Focus on input
                setTimeout(() => verificationCodeInput.focus(), 300);
            }
        }

        function startYouTubeTimer() {
            videoStartTime = Date.now();
            
            // Set initial countdown display to show full time
            const initialMinutes = Math.floor(requiredWatchTime / 60);
            const initialSeconds = requiredWatchTime % 60;
            document.getElementById('ytTimerCountdown').textContent = 
                `${initialMinutes}:${initialSeconds.toString().padStart(2, '0')}`;
            document.getElementById('ytTimerProgress').style.width = '0%';
            
            console.log(`⏱️ YouTube Timer starting: ${requiredWatchTime} seconds (${initialMinutes}:${initialSeconds.toString().padStart(2, '0')})`);
            
            // Clear any existing timer
            if (videoWatchTimer) {
                clearInterval(videoWatchTimer);
            }
            
            // Update timer every second
            videoWatchTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - videoStartTime) / 1000);
                const remaining = Math.max(0, requiredWatchTime - elapsed);
                const progress = Math.min(100, (elapsed / requiredWatchTime) * 100);
                
                // Update countdown display
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('ytTimerCountdown').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Update progress bar
                document.getElementById('ytTimerProgress').style.width = `${progress}%`;
                
                // Update status text
                const timerStatus = document.getElementById('ytTimerStatus');
                const submitButton = document.getElementById('ytSubmitButton');
                
                if (remaining > 0) {
                    timerStatus.textContent = `⏳ Keep watching... ${remaining}s remaining`;
                    timerStatus.className = 'text-xs text-gray-400 mt-2 block';
                } else {
                    timerStatus.textContent = '✅ Timer complete! You can now submit.';
                    timerStatus.className = 'text-xs text-neon-green mt-2 font-bold animate-pulse block';
                    
                    // ENABLE SUBMIT BUTTON (code input already enabled from start)
                    const verificationCodeInput = document.getElementById('ytVerificationCode');
                    
                    // Update hint text
                    document.getElementById('ytCodeInputHint').innerHTML = '✅ Timer complete! You can now submit.';
                    
                    console.log('✅ Timer complete - submit button enabled!');
                    
                    // ENABLE the submit button
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitButton.innerHTML = '<span id="ytSubmitButtonText">Submit Code & Claim Reward</span>';
                    
                    // Stop timer
                    clearInterval(videoWatchTimer);
                    videoWatchTimer = null;
                }
            }, 1000);
        }

        async function submitYouTubeQuest() {
            const code = document.getElementById('ytVerificationCode').value.trim();
            
            if (!code) {
                alert('⚠️ Please enter the verification code!');
                return;
            }
            
            const submitButton = document.getElementById('ytSubmitButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="text-2xl">⏳</span><span>SUBMITTING...</span>';
            
            try {
                const response = await fetch(`${API_URL}/tasks/${currentTaskId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        telegram_id: TELEGRAM_ID,
                        verification_code: code
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success!
                    submitButton.innerHTML = '<span class="text-2xl">✅</span><span>QUEST COMPLETED!</span>';
                    
                    // Show success message
                    alert(data.message || `🎉 Quest Completed!\n\n+${data.points_earned || currentTask.points_reward || 0} XP earned!`);
                    
                    // Reload data and go back to quest list
                    await loadTasks();
                    await loadProfile();
                    backToQuestList();
                } else {
                    throw new Error(data.message || 'Verification failed');
                }
            } catch (error) {
                console.error('Error submitting quest:', error);
                alert(`❌ ${error.message || 'Failed to submit quest. Please try again.'}`);
                submitButton.disabled = false;
                submitButton.innerHTML = '<span class="text-3xl">✅</span><span>SUBMIT CODE & COMPLETE</span>';
            }
        }

        async function submitRegularQuest() {
            const submitButton = document.getElementById('regQuestButton');
            const buttonText = document.getElementById('regQuestButtonText');
            
            // Special handling for Telegram quests
            if (currentTask.platform === 'telegram') {
                // Open Telegram link using WebApp API
                if (currentTaskUrl) {
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.openTelegramLink(currentTaskUrl);
                        console.log('✅ Opened Telegram link using WebApp API');
                    } else {
                        window.open(currentTaskUrl, '_blank');
                        console.log('✅ Opened in new window (testing mode)');
                    }
                }
                
                // Change button to "Verify Me"
                buttonText.textContent = '🔍 Verify Me';
                submitButton.onclick = verifyTelegramMembership;
                console.log('✅ Button changed to "Verify Me"');
                return;
            }
            
            // For non-Telegram quests, proceed as normal
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
            }
            
            submitButton.disabled = true;
            buttonText.textContent = '⏳ VERIFYING...';
            
            try {
                const response = await fetch(`${API_URL}/tasks/${currentTaskId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        telegram_id: TELEGRAM_ID
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success!
                    buttonText.textContent = '✅ QUEST COMPLETED!';
                    
                    // Show success message
                    alert(data.message || `🎉 Quest Completed!\n\n+${data.points_earned || currentTask.points_reward || 0} XP earned!`);
                    
                    // Reload data and go back to quest list
                    await loadTasks();
                    await loadProfile();
                    backToQuestList();
                } else {
                    throw new Error(data.message || 'Verification failed');
                }
            } catch (error) {
                console.error('Error submitting quest:', error);
                alert(`❌ ${error.message || 'Failed to complete quest. Please try again.'}`);
                submitButton.disabled = false;
                buttonText.textContent = 'Start mission';
            }
        }
        
        async function verifyTelegramMembership() {
            // Show the username input modal instead of directly verifying
            showTelegramUsernameModal();
        }
        
        function showTelegramUsernameModal() {
            const modal = document.getElementById('telegramUsernameModal');
            const input = document.getElementById('telegramUsernameInput');
            const errorDiv = document.getElementById('usernameError');
            const successDiv = document.getElementById('usernameSuccess');
            const submitBtn = document.getElementById('usernameSubmitBtn');
            const groupNameElement = document.getElementById('telegramGroupName');
            
            // Reset modal state
            input.value = '';
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            submitBtn.disabled = true;
            
            // Hide all validation indicators
            document.getElementById('usernameValidationIndicator').classList.add('hidden');
            document.getElementById('validationSpinner').classList.add('hidden');
            document.getElementById('validationCheck').classList.add('hidden');
            document.getElementById('validationCross').classList.add('hidden');
            
            // Extract and display the group name from current task
            let groupName = 'Telegram Group';
            if (currentTask) {
                // Try to get group name from various sources
                if (currentTask.verification_data && currentTask.verification_data.group_name) {
                    groupName = currentTask.verification_data.group_name;
                } else if (currentTask.verification_data && currentTask.verification_data.channel_name) {
                    groupName = currentTask.verification_data.channel_name;
                } else if (currentTask.title) {
                    // Extract from title if it contains "Join" pattern
                    // e.g., "Join BRGY Tamago Group" -> "BRGY Tamago Group"
                    groupName = currentTask.title.replace(/^Join\s+/i, '').trim();
                }
            }
            
            // Display the group name
            if (groupNameElement) {
                groupNameElement.textContent = groupName;
            }
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Focus on input
            setTimeout(() => input.focus(), 100);
            
            // Handle Enter key
            input.onkeypress = function(e) {
                if (e.key === 'Enter' && !submitBtn.disabled) {
                    submitTelegramVerification();
                }
            };
        }
        
        // Debounce timer for username validation
        let usernameValidationTimer = null;
        
        async function validateUsernameRealtime() {
            const input = document.getElementById('telegramUsernameInput');
            const indicator = document.getElementById('usernameValidationIndicator');
            const spinner = document.getElementById('validationSpinner');
            const checkMark = document.getElementById('validationCheck');
            const crossMark = document.getElementById('validationCross');
            const successDiv = document.getElementById('usernameSuccess');
            const errorDiv = document.getElementById('usernameError');
            const submitBtn = document.getElementById('usernameSubmitBtn');
            
            const username = input.value.trim().replace('@', '');
            
            // Clear previous timer
            if (usernameValidationTimer) {
                clearTimeout(usernameValidationTimer);
            }
            
            // Hide all states
            indicator.classList.add('hidden');
            spinner.classList.add('hidden');
            checkMark.classList.add('hidden');
            crossMark.classList.add('hidden');
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            submitBtn.disabled = true;
            
            // If empty, don't validate
            if (!username) {
                return;
            }
            
            // Show loading spinner immediately
            indicator.classList.remove('hidden');
            spinner.classList.remove('hidden');
            
            // Debounce: Wait 500ms after user stops typing
            usernameValidationTimer = setTimeout(async () => {
                try {
                    // Check username against database
                    console.log(`🔍 Validating username: ${username}`);
                    console.log(`   Current user TELEGRAM_ID: ${TELEGRAM_ID}`);
                    
                    const response = await fetch(`${API_URL}/users/telegram/username/${username}`);
                    
                    console.log(`   Response status: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`   Response data:`, data);
                        console.log(`   data.telegram_id: ${data.telegram_id} (${typeof data.telegram_id})`);
                        console.log(`   TELEGRAM_ID: ${TELEGRAM_ID} (${typeof TELEGRAM_ID})`);
                        
                        // Username found and matches current user (compare as strings)
                        if (data && String(data.telegram_id) === String(TELEGRAM_ID)) {
                            console.log(`   ✅ Match! Username belongs to current user`);
                            spinner.classList.add('hidden');
                            checkMark.classList.remove('hidden');
                            successDiv.classList.remove('hidden');
                            submitBtn.disabled = false;
                            
                            // Change input border to green
                            input.classList.remove('border-neon-blue/30', 'border-red-500/50');
                            input.classList.add('border-green-500/50');
                        } else if (data) {
                            // Username exists but belongs to different user
                            console.log(`   ❌ Username belongs to different user`);
                            spinner.classList.add('hidden');
                            crossMark.classList.remove('hidden');
                            errorDiv.classList.remove('hidden');
                            document.getElementById('usernameErrorText').textContent = 'This username belongs to a different account';
                            
                            // Change input border to red
                            input.classList.remove('border-neon-blue/30', 'border-green-500/50');
                            input.classList.add('border-red-500/50');
                        }
                    } else {
                        // Username not found in database
                        console.log(`   ❌ Username not found in database`);
                        spinner.classList.add('hidden');
                        crossMark.classList.remove('hidden');
                        errorDiv.classList.remove('hidden');
                        document.getElementById('usernameErrorText').textContent = 'Username not found. Please make sure you\'re registered.';
                        
                        // Change input border to red
                        input.classList.remove('border-neon-blue/30', 'border-green-500/50');
                        input.classList.add('border-red-500/50');
                    }
                } catch (error) {
                    console.error('Error validating username:', error);
                    spinner.classList.add('hidden');
                    indicator.classList.add('hidden');
                    
                    // Reset border
                    input.classList.remove('border-green-500/50', 'border-red-500/50');
                    input.classList.add('border-neon-blue/30');
                }
            }, 500);
        }
        
        function closeTelegramUsernameModal() {
            const modal = document.getElementById('telegramUsernameModal');
            modal.classList.add('hidden');
            
            // Clear validation timer
            if (usernameValidationTimer) {
                clearTimeout(usernameValidationTimer);
            }
        }
        
        async function submitTelegramVerification() {
            const input = document.getElementById('telegramUsernameInput');
            const submitBtn = document.getElementById('usernameSubmitBtn');
            const submitBtnText = document.getElementById('usernameSubmitBtnText');
            const errorDiv = document.getElementById('usernameError');
            const errorText = document.getElementById('usernameErrorText');
            
            const username = input.value.trim().replace('@', '');
            
            // Validate username
            if (!username) {
                errorText.textContent = 'Please enter your Telegram username';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtnText.textContent = '⏳ Verifying...';
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_URL}/tasks/${currentTaskId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        telegram_id: TELEGRAM_ID,
                        telegram_username: username  // Send the username
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success! User is verified as a member
                    submitBtnText.textContent = '✅ VERIFIED!';
                    
                    // Close username modal
                    setTimeout(() => {
                        closeTelegramUsernameModal();
                    }, 300);
                    
                    // Update the main button
                    const submitButton = document.getElementById('regQuestButton');
                    const buttonText = document.getElementById('regQuestButtonText');
                    if (submitButton && buttonText) {
                        submitButton.disabled = true;
                        buttonText.textContent = '✅ VERIFIED!';
                    }
                    
                    // Show congratulations modal with rewards
                    setTimeout(() => {
                        const pointsEarned = data.points_earned || currentTask.points_reward || 0;
                        const congratsModal = document.createElement('div');
                        congratsModal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-50 animate-fade-in';
                        congratsModal.innerHTML = `
                            <div class="bg-gradient-to-br from-neon-blue via-cyber-purple to-neon-pink text-white px-10 py-8 rounded-2xl shadow-2xl text-center max-w-md mx-4 transform scale-95 animate-scale-in border-2 border-neon-blue/50">
                                <div class="text-6xl mb-4 animate-bounce">🎉</div>
                                <div class="text-3xl font-bold mb-3 text-shadow-neon">Telegram Quest Complete!</div>
                                <div class="text-xl mb-4">
                                    <div class="bg-black/30 rounded-lg px-6 py-4 mb-3 border border-neon-blue/30">
                                        <div class="text-sm opacity-80 mb-1">Verified Member</div>
                                        <div class="text-2xl font-bold text-neon-blue">@${username}</div>
                                    </div>
                                    <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 rounded-lg px-6 py-4 border border-yellow-500/50">
                                        <div class="text-sm opacity-80 mb-1">Rewards Earned</div>
                                        <div class="text-3xl font-bold text-yellow-300">+${pointsEarned} XP</div>
                                    </div>
                                </div>
                                <div class="text-sm opacity-90 mt-4 animate-pulse">🎮 Returning to quests...</div>
                            </div>
                        `;
                        document.body.appendChild(congratsModal);
                        
                        // Reload data and return to quest list
                        setTimeout(async () => {
                            congratsModal.remove();
                            await loadTasks();
                            await loadProfile();
                            backToQuestList();
                        }, 3000);
                    }, 400);
                } else {
                    throw new Error(data.message || 'Verification failed');
                }
            } catch (error) {
                console.error('Error verifying membership:', error);
                errorText.textContent = error.message || 'Verification failed. Please make sure you joined the group and entered the correct username!';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtnText.textContent = '✅ Verify';
            }
        }

        function openVideoAndShowCodeInput() {
            // Open the video in a new tab
            if (currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
            }
            
            // Keep watch section visible (don't hide it)
            // Code input section is already visible
            
            // Get minimum watch time from task - check top-level column first, then verification_data
            const taskWatchTime = currentTask?.min_watch_time_seconds;
            const verificationData = currentTask?.verification_data || {};
            const verificationWatchTime = verificationData.min_watch_time || verificationData.min_watch_time_seconds;
            requiredWatchTime = taskWatchTime || verificationWatchTime || 30;
            
            console.log('🎬 YouTube quest watch time:', requiredWatchTime, 'seconds (from', taskWatchTime ? 'task column' : 'verification_data', ')');
            
            // Get UI elements
            const timerDisplay = document.getElementById('timerDisplay');
            const codeLockOverlay = document.getElementById('codeLockOverlay');
            const verificationCodeInput = document.getElementById('verificationCode');
            const codeInputHint = document.getElementById('codeInputHint');
            
            // Show timer if there's a minimum watch time
            if (requiredWatchTime > 0) {
                // Show timer display
                timerDisplay.classList.remove('hidden');
                
                // Keep input locked (already locked from showTaskDetail)
                codeLockOverlay.classList.remove('hidden');
                verificationCodeInput.disabled = true;
                verificationCodeInput.setAttribute('placeholder', '⏳ LOCKED - TIMER RUNNING');
                codeInputHint.innerHTML = '🔒 Wait for timer to complete...';
                
                // Start the timer
                startWatchTimer();
            } else {
                // No timer required - unlock immediately
                timerDisplay.classList.add('hidden');
                codeLockOverlay.classList.add('hidden');
                verificationCodeInput.disabled = false;
                verificationCodeInput.setAttribute('placeholder', 'ENTER CODE HERE');
                codeInputHint.innerHTML = '💡 Tip: The code is usually shown as text in the video';
            }
            
            // Show and update the submit button (initially disabled if timer is active)
            const questActionButton = document.getElementById('questActionButton');
            questActionButton.classList.remove('hidden');
            
            if (requiredWatchTime > 0) {
                questActionButton.disabled = true;
                questActionButton.classList.add('opacity-50', 'cursor-not-allowed');
                questActionButton.innerHTML = '<span class="text-2xl">⏳</span><span>WAITING FOR TIMER...</span>';
            } else {
                questActionButton.disabled = false;
                questActionButton.classList.remove('opacity-50', 'cursor-not-allowed');
                questActionButton.innerHTML = '<span class="text-3xl">✅</span><span>SUBMIT CODE & COMPLETE</span>';
            }
            
            // Focus on the code input
            setTimeout(() => {
                document.getElementById('verificationCode').focus();
            }, 300);
        }

        function startWatchTimer() {
            videoStartTime = Date.now();
            
            // Clear any existing timer
            if (videoWatchTimer) {
                clearInterval(videoWatchTimer);
            }
            
            // Update timer every second
            videoWatchTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - videoStartTime) / 1000);
                const remaining = Math.max(0, requiredWatchTime - elapsed);
                const progress = Math.min(100, (elapsed / requiredWatchTime) * 100);
                
                // Update countdown display
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('timerCountdown').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Update progress bar
                document.getElementById('timerProgress').style.width = `${progress}%`;
                
                // Update status text
                const timerStatus = document.getElementById('timerStatus');
                const questActionButton = document.getElementById('questActionButton');
                
                if (remaining > 0) {
                    timerStatus.textContent = `⏳ Keep watching... ${remaining}s remaining`;
                    timerStatus.className = 'text-xs text-gray-400 mt-2';
                } else {
                    timerStatus.textContent = '✅ Timer complete! You can now submit.';
                    timerStatus.className = 'text-xs text-neon-green mt-2 font-bold animate-pulse';
                    
                    // UNLOCK CODE INPUT
                    const codeLockOverlay = document.getElementById('codeLockOverlay');
                    const verificationCodeInput = document.getElementById('verificationCode');
                    const codeInputHint = document.getElementById('codeInputHint');
                    
                    if (codeLockOverlay) codeLockOverlay.classList.add('hidden');
                    if (verificationCodeInput) {
                        verificationCodeInput.disabled = false;
                        verificationCodeInput.setAttribute('placeholder', 'ENTER CODE HERE');
                    }
                    if (codeInputHint) {
                        codeInputHint.innerHTML = '✅ Timer complete! Enter your code now';
                    }
                    
                    // Focus on code input
                    setTimeout(() => {
                        if (verificationCodeInput) verificationCodeInput.focus();
                    }, 300);
                    
                    // Enable submit button (try both button IDs)
                    if (questActionButton) {
                        questActionButton.disabled = false;
                        questActionButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        questActionButton.innerHTML = '<span class="text-3xl">✅</span><span>SUBMIT CODE & COMPLETE</span>';
                    }
                    
                    // ALSO enable the YouTube submit button
                    const youtubeSubmitBtn = document.getElementById('youtubeSubmitBtn');
                    if (youtubeSubmitBtn) {
                        console.log('🔓 ENABLING youtubeSubmitBtn after timer complete');
                        youtubeSubmitBtn.disabled = false;
                        youtubeSubmitBtn.removeAttribute('disabled');
                        youtubeSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'disabled');
                        youtubeSubmitBtn.style.opacity = '1';
                        youtubeSubmitBtn.style.cursor = 'pointer';
                        youtubeSubmitBtn.style.pointerEvents = 'auto';
                        youtubeSubmitBtn.innerHTML = '<span class="text-2xl">✅</span> <span>Submit Code & Claim Reward</span>';
                        console.log('✅ youtubeSubmitBtn enabled!');
                    }
                    
                    // Stop the timer
                    clearInterval(videoWatchTimer);
                    videoWatchTimer = null;
                }
            }, 1000);
        }

        function stopWatchTimer() {
            if (videoWatchTimer) {
                clearInterval(videoWatchTimer);
                videoWatchTimer = null;
            }
            videoStartTime = null;
        }

        function closeTaskModal() {
            // Stop watch timer if running
            stopWatchTimer();
            
            // Reset code input lock state
            const codeLockOverlay = document.getElementById('codeLockOverlay');
            const verificationCodeInput = document.getElementById('verificationCode');
            if (codeLockOverlay) codeLockOverlay.classList.add('hidden');
            if (verificationCodeInput) {
                verificationCodeInput.disabled = false;
                verificationCodeInput.value = '';
            }
            
            // Hide timer display
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) timerDisplay.classList.add('hidden');
            
            document.getElementById('taskModal').classList.add('hidden');
            document.body.style.overflow = '';
            currentTaskId = null;
            currentTaskUrl = null;
            currentTask = null;
            document.getElementById('verificationCode').value = '';
            
            // Hide timer display
            document.getElementById('timerDisplay').classList.add('hidden');
        }

        async function completeTask() {
            if (!currentTaskId) return;
            
            // Check if code is required for YouTube quests
            const needsCode = currentTask && 
                             (currentTask.task_type === 'youtube' || currentTask.task_type === 'youtube_watch') &&
                             (currentTask.verification_data?.method === 'video_code' || 
                              currentTask.verification_data?.method === 'youtube_code' || 
                              currentTask.verification_data?.method === 'time_delay_code');
            
            if (needsCode) {
                const code = document.getElementById('verificationCode').value.trim();
                if (!code) {
                    alert('⚠️ Please enter the verification code from the video!');
                    return;
                }
            }
            
            // For non-YouTube quests, open the URL
            if (!needsCode && currentTaskUrl) {
                window.open(currentTaskUrl, '_blank');
            }
            
            // Submit completion
            try {
                const requestBody = {
                    telegram_id: TELEGRAM_ID,
                    task_id: currentTaskId
                };
                
                // Add code if needed
                if (needsCode) {
                    requestBody.verification_code = document.getElementById('verificationCode').value.trim();
                }
                
                const response = await fetch(`${API_URL}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Stop timer if running
                    stopWatchTimer();
                    
                    alert('🎉 Quest Completed! +' + result.points_earned + ' XP');
                    loadUserData();
                    loadTasks(); // Reload to hide completed tasks
                    closeTaskModal();
                } else {
                    // Check if task was already completed
                    if (result.message === 'Task already completed') {
                        // Stop timer if running
                        stopWatchTimer();
                        
                        alert('✅ You already completed this quest!');
                        loadTasks(); // Reload to hide this task
                        closeTaskModal();
                    } else {
                        alert('❌ Verification failed: ' + (result.message || 'Please complete the task and try again'));
                    }
                }
            } catch (error) {
                console.error(error);
                alert('⚠️ Error verifying quest. Please try again.');
            }
        }

        // Close modal when clicking outside
        document.getElementById('taskModal').addEventListener('click', (e) => {
            if (e.target.id === 'taskModal') {
                closeTaskModal();
            }
        });

        // Check server status immediately
        checkServerStatus();
        // Check server status every 30 seconds
        setInterval(checkServerStatus, 30000);

        // Only load data if user has participated
        if (userHasParticipated) {
            loadUserData();
            loadTasks();
            setInterval(loadUserData, 30000);
        }
    </script>
</body>
</html>
