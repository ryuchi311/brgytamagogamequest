<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Gaming Quest Hub | Earn XP & Rewards</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Brgy Tamago Official Brand Colors
                        'brand-gold': '#fdbd16',        // Primary Gold/Yellow
                        'brand-red': '#f22524',         // Primary Red
                        'brand-black': '#1f1f20',       // Dark Background
                        'brand-white': '#ffffff',       // White
                        'brand-beige': '#e3c293',       // Tan/Beige accent
                        'brand-orange': '#ef6d1f',      // Orange accent
                        'brand-gray': '#585858',        // Gray (keeping from old)
                        
                        // Derived shades for gradients
                        'brand-gold-light': '#ffd03a',
                        'brand-gold-dark': '#e5aa00',
                        'brand-red-light': '#ff4447',
                        'brand-red-dark': '#d01619',
                        
                        // Legacy compatibility (mapped to new colors)
                        'gaming-dark': '#1f1f20',
                        'gaming-darker': '#151515',
                        'neon-blue': '#fdbd16',
                        'neon-purple': '#f22524',
                        'neon-pink': '#ff4447',
                        'neon-green': '#fdbd16',
                        'neon-yellow': '#ffd03a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');
        
        body { 
            font-family: 'Rajdhani', sans-serif; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, #202020 0%, #151515 50%, #202020 100%);
        }
        
        .gaming-title { font-family: 'Orbitron', sans-serif; }
        
        /* Brand Gradient Text - Gold to Red with shimmer */
        .gradient-text { 
            background: linear-gradient(90deg, #fdbd16 0%, #f22524 50%, #fdbd16 100%); 
            background-size: 200% auto;
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        /* Fade-in animation for welcome screen */
        @keyframes fade-in {
            from { 
                opacity: 0; 
                transform: scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: scale(1);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.5s ease-out;
        }
        
        /* Pulse animation for participate button */
        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(253, 189, 22, 0.7);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(253, 189, 22, 0);
            }
        }
        
        /* Activity filter buttons */
        .activity-filter {
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .activity-filter.active {
            background: rgba(253, 189, 22, 0.3) !important;
            color: #fdbd16 !important;
            border: 1px solid rgba(253, 189, 22, 0.5);
        }
        .activity-filter:hover {
            transform: scale(1.05);
        }
        
        .content-wrapper { padding-bottom: env(safe-area-inset-bottom, 80px); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 -4px 20px rgba(0, 212, 255, 0.3); padding-bottom: env(safe-area-inset-bottom, 0); }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 8px 0; transition: all 0.3s ease; position: relative; }
        .bottom-nav-item.active { color: #00d4ff; }
        .bottom-nav-item.active::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: linear-gradient(90deg, #00d4ff, #b537f2); border-radius: 0 0 10px 10px; }
        .bottom-nav-icon { font-size: 24px; line-height: 1; margin-bottom: 4px; }
        .bottom-nav-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body class="bg-gaming-darker text-white">
    <div class="min-h-screen bg-gradient-to-br from-gaming-darker via-gaming-dark to-gaming-darker">
        <div class="content-wrapper">
            <header class="bg-gradient-to-r from-gaming-dark/95 to-purple-900/60 backdrop-blur-lg shadow-2xl p-4 mb-4 border-b border-neon-blue/30 sticky top-0 z-40">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-neon-blue to-neon-purple rounded-xl flex items-center justify-center text-2xl">üéÆ</div>
                        <div>
                            <h1 class="text-xl font-black gaming-title gradient-text leading-none">QUEST HUB</h1>
                            <p class="text-neon-blue text-xs">Earn XP  ‚Ä¢ Level Up</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="bg-gradient-to-r from-neon-purple to-neon-pink px-4 py-2 rounded-xl border border-neon-pink/50">
                            <div class="text-xs text-gray-300 leading-none mb-1">XP</div>
                            <div id="userPoints" class="text-lg font-black gaming-title leading-none">...</div>
                        </div>
                        <div id="serverStatus" class="p-2 rounded-lg" title="Server Status">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="8" />
                            </svg>
                        </div>
                    </div>
                </div>
            </header>

            <main class="px-4 pb-4">
                <section id="tasks" class="tab-content">
                    <div class="mb-3 flex items-center justify-between">
                        <h2 class="text-xl font-black gaming-title gradient-text">‚öîÔ∏è Active Quests</h2>
                        <span id="tasksCount" class="text-xs bg-neon-blue/20 px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="tasksContainer" class="space-y-3">
                        <div class="text-center py-12 text-neon-blue">‚ö° Loading Quests...</div>
                    </div>
                </section>

                <section id="leaderboard" class="tab-content hidden">
                    <div class="mb-3">
                        <h2 class="text-xl font-black gaming-title gradient-text">üèÜ Top Players</h2>
                    </div>
                    <div id="leaderboardContainer" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <div class="animate-spin text-4xl mb-2">‚ö°</div>
                            <div>Loading rankings...</div>
                        </div>
                    </div>
                </section>

                <section id="rewards" class="tab-content hidden">
                    <div class="mb-3">
                        <h2 class="text-xl font-black gaming-title gradient-text">ÔøΩÔøΩ Epic Loot</h2>
                    </div>
                    <div id="rewardsContainer" class="space-y-3">
                        <div class="text-center py-12 text-neon-blue">Loading rewards...</div>
                    </div>
                </section>

                <section id="profile" class="tab-content hidden">
                    <div class="mb-2">
                        <h2 class="text-lg font-black gaming-title gradient-text">üë§ Your Profile</h2>
                    </div>
                    <div class="space-y-2">
                        <!-- User Stats Card -->
                        <div class="bg-gaming-dark/80 backdrop-blur-md rounded-xl p-3 border border-neon-blue/30">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-neon-blue to-neon-purple rounded-full flex items-center justify-center text-2xl">üë§</div>
                                <div class="flex-1">
                                    <div class="text-base font-bold gaming-title" id="profileUsername">Player</div>
                                    <div class="text-xs text-gray-400">Level <span id="profileLevel">1</span></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center">
                                    <div class="text-xl font-black gaming-title text-neon-blue" id="profileQuests">0</div>
                                    <div class="text-xs text-gray-400">Quests</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center">
                                    <div class="text-xl font-black gaming-title text-neon-purple" id="profileRank">-</div>
                                    <div class="text-xs text-gray-400">Rank</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center">
                                    <div class="text-xl font-black gaming-title text-neon-pink" id="profileXP">0</div>
                                    <div class="text-xs text-gray-400">XP</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quest Activity Log -->
                        <div class="bg-gaming-dark/80 backdrop-blur-md rounded-xl p-3 border border-brand-gold/30">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-base font-black gaming-title text-brand-gold">üìú Quest Activity</h3>
                                <div class="flex gap-1 text-xs">
                                    <button onclick="filterActivity('all')" id="filterAll" class="activity-filter active px-2 py-1 rounded-full bg-brand-gold/20 text-brand-gold text-xs">All</button>
                                    <button onclick="filterActivity('success')" id="filterSuccess" class="activity-filter px-2 py-1 rounded-full bg-gray-700/50 text-gray-400 text-xs">‚úì</button>
                                    <button onclick="filterActivity('failed')" id="filterFailed" class="activity-filter px-2 py-1 rounded-full bg-gray-700/50 text-gray-400 text-xs">‚úó</button>
                                </div>
                            </div>
                            
                            <!-- Activity Stats -->
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center border border-gray-700/30">
                                    <div class="text-sm font-bold text-green-400" id="successCount">0</div>
                                    <div class="text-xs text-gray-500">Success</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center border border-gray-700/30">
                                    <div class="text-sm font-bold text-red-400" id="failedCount">0</div>
                                    <div class="text-xs text-gray-500">Failed</div>
                                </div>
                                <div class="bg-gaming-darker/50 rounded-lg p-2 text-center border border-gray-700/30">
                                    <div class="text-sm font-bold text-blue-400" id="successRate">0%</div>
                                    <div class="text-xs text-gray-500">Rate</div>
                                </div>
                            </div>

                            <!-- Activity List -->
                            <div id="activityContainer" class="space-y-2 max-h-80 overflow-y-auto">
                                <div class="text-center py-6 text-gray-500 text-sm">
                                    <div class="text-3xl mb-2">üéØ</div>
                                    <div>Complete quests to see your activity!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="notifications" class="tab-content hidden">
                    <div class="mb-3">
                        <h2 class="text-xl font-black gaming-title gradient-text">üì° Mission Control</h2>
                    </div>
                    <div id="notificationsContainer" class="space-y-2">
                        <div class="text-center py-12 text-neon-blue">Loading alerts...</div>
                    </div>
                </section>
            </main>
        </div>

        <nav class="bottom-nav bg-gaming-dark/95 border-t border-neon-blue/30">
            <div class="flex items-center justify-around max-w-xl mx-auto">
                <button class="bottom-nav-item active" onclick="showTab('tasks', this)">
                    <div class="bottom-nav-icon">‚öîÔ∏è</div>
                    <div class="bottom-nav-label">Quests</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('leaderboard', this)">
                    <div class="bottom-nav-icon">üèÜ</div>
                    <div class="bottom-nav-label">Ranks</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('rewards', this)">
                    <div class="bottom-nav-icon">üíé</div>
                    <div class="bottom-nav-label">Rewards</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('profile', this)">
                    <div class="bottom-nav-icon">üë§</div>
                    <div class="bottom-nav-label">Profile</div>
                </button>
                <button class="bottom-nav-item" onclick="showTab('notifications', this)">
                    <div class="bottom-nav-icon">üì°</div>
                    <div class="bottom-nav-label">Alerts</div>
                </button>
            </div>
        </nav>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-end md:items-center justify-center">
        <div class="bg-gaming-dark w-full md:max-w-lg md:rounded-3xl rounded-t-3xl border-t md:border border-neon-blue/30 shadow-[0_0_50px_rgba(0,149,255,0.3)] max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gaming-dark/95 backdrop-blur-md p-4 border-b border-neon-blue/30 flex items-center justify-between">
                <h3 class="text-xl font-black gaming-title gradient-text" id="modalTitle">Quest Details</h3>
                <button onclick="closeTaskModal()" class="text-3xl text-gray-400 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-5xl" id="modalEmoji">üéØ</div>
                    <div>
                        <div class="text-sm text-gray-400 uppercase tracking-wide" id="modalPlatform">Platform</div>
                        <div class="text-3xl font-black gaming-title text-neon-green" id="modalPoints">+0 XP</div>
                    </div>
                </div>
                <div class="bg-gaming-darker/50 rounded-xl p-4">
                    <p class="text-sm text-gray-300 leading-relaxed" id="modalDescription">Quest description goes here</p>
                </div>
                
                <!-- Code Input for YouTube/Time-delay quests -->
                <div id="codeInputSection" class="hidden space-y-3">
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                        <p class="text-sm text-yellow-300">
                            ‚è±Ô∏è Watch the video and enter the code shown at <span id="codeTime" class="font-bold">0:00</span>
                        </p>
                    </div>
                    <input 
                        type="text" 
                        id="verificationCode" 
                        placeholder="Enter verification code"
                        class="w-full bg-gaming-darker border-2 border-neon-blue/30 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-neon-blue transition-colors"
                    >
                </div>
                
                <button onclick="completeTask()" class="w-full bg-gradient-to-r from-neon-blue to-neon-purple text-white font-bold py-4 rounded-xl hover:shadow-[0_0_30px_rgba(0,149,255,0.5)] transition-all active:scale-95">
                    üöÄ START QUEST
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - API URL
        // Handle both localhost and GitHub Codespaces URLs
        let API_BASE;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Local development
            API_BASE = window.location.origin.replace(':8080', ':8000');
        } else {
            // GitHub Codespaces - replace 8080 port in URL
            API_BASE = window.location.origin.replace('-8080.', '-8000.');
        }
        const API_URL = `${API_BASE}/api`;
        
        // Telegram Mini App Integration
        let TELEGRAM_ID = null;
        let TELEGRAM_USER = null;
        
        // Initialize Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // Get user data from Telegram
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                TELEGRAM_USER = tg.initDataUnsafe.user;
                TELEGRAM_ID = TELEGRAM_USER.id;
                console.log('Telegram user authenticated:', TELEGRAM_USER);
            }
        }
        
        // Track if user has started participating
        let userHasParticipated = false;
        
        // Check if user is authenticated via Telegram
        function checkTelegramAuth() {
            if (!TELEGRAM_ID) {
                // Show authentication required message
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-gaming-darker via-gaming-dark to-gaming-darker flex items-center justify-center p-6">
                        <div class="max-w-md w-full bg-gaming-dark/90 backdrop-blur-md rounded-3xl p-8 border-2 border-brand-gold/30 text-center">
                            <div class="text-6xl mb-6">üîí</div>
                            <h1 class="text-3xl font-black gaming-title gradient-text mb-4">TELEGRAM REQUIRED</h1>
                            <p class="text-gray-300 mb-6 leading-relaxed">
                                This is a Telegram Mini App. You must access it through Telegram to participate in quests and earn rewards.
                            </p>
                            <div class="bg-brand-gold/10 border border-brand-gold/30 rounded-xl p-4 mb-6">
                                <div class="text-sm font-bold text-brand-gold mb-2">üì± How to Access:</div>
                                <ol class="text-xs text-left text-gray-300 space-y-2 ml-4 list-decimal">
                                    <li>Open Telegram app</li>
                                    <li>Search for our bot</li>
                                    <li>Click "Start" or "Play Game"</li>
                                    <li>Complete quests & earn XP!</li>
                                </ol>
                            </div>
                            <div class="text-xs text-gray-500 mt-6">
                                ‚ö†Ô∏è Direct browser access is not supported
                            </div>
                        </div>
                    </div>
                `;
                return false;
            }
            return true;
        }
        
        // Show welcome screen with participate button
        function showWelcomeScreen() {
            const welcomeScreen = document.createElement('div');
            welcomeScreen.id = 'welcomeScreen';
            welcomeScreen.className = 'fixed inset-0 z-50 bg-gradient-to-br from-gaming-darker via-gaming-dark to-gaming-darker flex items-center justify-center p-6';
            welcomeScreen.innerHTML = `
                <div class="max-w-lg w-full bg-gaming-dark/95 backdrop-blur-xl rounded-3xl p-8 border-2 border-brand-gold/50 text-center shadow-2xl animate-fade-in">
                    <div class="text-7xl mb-6 animate-bounce">üéÆ</div>
                    <h1 class="text-4xl font-black gaming-title gradient-text mb-4 leading-tight">
                        WELCOME TO<br>QUEST HUB!
                    </h1>
                    <div class="bg-brand-gold/10 border border-brand-gold/30 rounded-2xl p-5 mb-6">
                        <div class="text-lg font-bold text-brand-gold mb-2">üëã Hey ${TELEGRAM_USER.first_name || 'Player'}!</div>
                        <p class="text-gray-300 text-sm leading-relaxed">
                            You're about to embark on an epic quest journey! Complete challenges, earn XP, and unlock awesome rewards.
                        </p>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="bg-gaming-darker/50 rounded-xl p-3">
                            <div class="text-2xl mb-1">‚öîÔ∏è</div>
                            <div class="text-xs text-gray-400">Epic<br>Quests</div>
                        </div>
                        <div class="bg-gaming-darker/50 rounded-xl p-3">
                            <div class="text-2xl mb-1">üíé</div>
                            <div class="text-xs text-gray-400">Earn<br>XP</div>
                        </div>
                        <div class="bg-gaming-darker/50 rounded-xl p-3">
                            <div class="text-2xl mb-1">üèÜ</div>
                            <div class="text-xs text-gray-400">Win<br>Rewards</div>
                        </div>
                    </div>
                    <button 
                        onclick="startParticipating()" 
                        class="w-full bg-gradient-to-r from-brand-gold to-brand-orange hover:from-brand-gold-light hover:to-brand-gold text-gaming-dark font-black text-lg py-4 px-8 rounded-xl transition-all transform hover:scale-105 active:scale-95 shadow-lg gaming-title"
                        style="animation: pulse 2s infinite;">
                        üöÄ PARTICIPATE NOW!
                    </button>
                    <div class="mt-4 text-xs text-gray-500">
                        ‚ú® No signup required ‚Ä¢ Start playing instantly!
                    </div>
                </div>
            `;
            document.body.appendChild(welcomeScreen);
        }
        
        // Start participating - initialize user and load game
        async function startParticipating() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const button = welcomeScreen.querySelector('button');
            
            // Show loading state
            button.innerHTML = '‚è≥ Initializing...';
            button.disabled = true;
            
            try {
                // Check if user exists, if not create account
                let response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                
                if (response.status === 404) {
                    // Create new user automatically
                    const username = TELEGRAM_USER.username || `player${TELEGRAM_ID}`;
                    const firstName = TELEGRAM_USER.first_name || 'Player';
                    const lastName = TELEGRAM_USER.last_name || '';
                    
                    button.innerHTML = 'üé® Creating Your Profile...';
                    
                    await fetch(`${API_URL}/users/init?telegram_id=${TELEGRAM_ID}&username=${encodeURIComponent(username)}&first_name=${encodeURIComponent(firstName)}&last_name=${encodeURIComponent(lastName)}`, {
                        method: 'POST'
                    });
                    
                    // Wait a moment for dramatic effect
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                button.innerHTML = '‚úÖ Ready! Starting Game...';
                
                // Mark as participated
                userHasParticipated = true;
                localStorage.setItem('userParticipated_' + TELEGRAM_ID, 'true');
                
                // Fade out welcome screen
                welcomeScreen.style.opacity = '0';
                welcomeScreen.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    welcomeScreen.remove();
                    // Load user data and start the game
                    loadUserData();
                    loadTasks();
                }, 500);
                
            } catch (error) {
                console.error('Error starting participation:', error);
                button.innerHTML = '‚ùå Error - Try Again';
                button.disabled = false;
            }
        }
        
        // Block access if not from Telegram
        if (!checkTelegramAuth()) {
            throw new Error('Telegram authentication required');
        }
        
        // Check if user has already participated
        const hasParticipated = localStorage.getItem('userParticipated_' + TELEGRAM_ID);
        if (!hasParticipated) {
            // Show welcome screen on first visit
            showWelcomeScreen();
        } else {
            // User has participated before, load game directly
            userHasParticipated = true;
        }
        
        console.log('API_URL configured:', API_URL);
        console.log('Telegram ID:', TELEGRAM_ID);

        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            if (btn) btn.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (tabName === 'leaderboard') loadLeaderboard();
            if (tabName === 'rewards') loadRewards();
            if (tabName === 'profile') loadProfile();
            if (tabName === 'notifications') loadNotifications();
        }

        // Server Status Monitoring
        async function checkServerStatus() {
            const statusIcon = document.getElementById('serverStatus');
            if (!statusIcon) return;
            
            let apiStatus = false;
            let botStatus = false;
            
            // Check API Server
            try {
                const apiResponse = await fetch(`${API_URL}/tasks`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000) // 5 second timeout
                });
                apiStatus = apiResponse.ok;
            } catch (error) {
                console.log('API check failed:', error);
            }
            
            // Check Bot Server (optional - checks if bot endpoint responds)
            try {
                const botResponse = await fetch(`${API_URL}/health`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                botStatus = botResponse.ok;
            } catch (error) {
                // Bot health endpoint might not exist, default to API status
                botStatus = apiStatus;
            }
            
            // Update status indicator
            if (apiStatus && botStatus) {
                // All good - Green
                statusIcon.className = 'p-2 rounded-lg text-green-500';
                statusIcon.title = 'All Systems Operational';
            } else if (apiStatus || botStatus) {
                // Partial - Yellow
                statusIcon.className = 'p-2 rounded-lg text-yellow-500';
                statusIcon.title = 'Some Services Down';
            } else {
                // Down - Red
                statusIcon.className = 'p-2 rounded-lg text-red-500';
                statusIcon.title = 'Server Offline';
            }
        }

        async function loadUserData() {
            try {
                let response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                
                // If user doesn't exist, create them automatically with Telegram data
                if (response.status === 404) {
                    const username = TELEGRAM_USER.username || `player${TELEGRAM_ID}`;
                    const firstName = TELEGRAM_USER.first_name || 'Player';
                    const lastName = TELEGRAM_USER.last_name || '';
                    
                    await fetch(`${API_URL}/users/init?telegram_id=${TELEGRAM_ID}&username=${encodeURIComponent(username)}&first_name=${encodeURIComponent(firstName)}&last_name=${encodeURIComponent(lastName)}`, {
                        method: 'POST'
                    });
                    response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                }
                
                const user = await response.json();
                document.getElementById('userPoints').textContent = user.points || 0;
                
                // Update profile display with Telegram data
                if (TELEGRAM_USER) {
                    const displayName = TELEGRAM_USER.first_name || user.username || 'Player';
                    document.getElementById('profileUsername').textContent = displayName;
                }
            } catch (error) {
                console.error('Error loading user:', error);
                document.getElementById('userPoints').textContent = '---';
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/tasks`);
                const allTasks = await response.json();
                
                // Get user's completed tasks
                let completedTaskIds = new Set();
                if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                    try {
                        const telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
                        const userTasksResponse = await fetch(`${API_URL}/users/${telegramId}/tasks`);
                        const userTasks = await userTasksResponse.json();
                        
                        // Get IDs of completed tasks
                        completedTaskIds = new Set(
                            userTasks
                                .filter(ut => ut.status === 'completed')
                                .map(ut => ut.task_id)
                        );
                    } catch (e) {
                        console.log('Could not fetch user tasks:', e);
                    }
                }
                
                // Filter out completed tasks
                const tasks = allTasks.filter(task => !completedTaskIds.has(task.id));
                
                const container = document.getElementById('tasksContainer');
                document.getElementById('tasksCount').textContent = tasks.length;
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="text-center py-12 text-gray-400">üéâ All quests completed! Check back later for new quests.</div>';
                    return;
                }

                // Store tasks globally for access
                window.tasksData = tasks;
                
                container.innerHTML = tasks.map((task, index) => {
                    const platformEmoji = {
                        'youtube': 'üì∫',
                        'twitter': 'üê¶',
                        'telegram': '‚úàÔ∏è',
                        'discord': 'üí¨',
                        'instagram': 'üì∑'
                    }[task.platform] || 'üéØ';
                    
                    const platformName = task.platform || 'general';
                    const points = task.points_reward || 0;
                    
                    return `
                        <div class="bg-gaming-dark/80 rounded-xl p-4 border border-neon-blue/30 active:scale-95 transition-all cursor-pointer hover:border-neon-purple/50" onclick="showTaskDetail(${index})">
                            <div class="flex items-start gap-3">
                                <div class="text-3xl">${platformEmoji}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-sm mb-1">${task.title}</h3>
                                    <p class="text-xs text-gray-400 mb-2">${task.description || 'Complete this quest to earn points!'}</p>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs px-2 py-1 bg-neon-blue/20 text-neon-blue rounded-full uppercase">${platformName}</span>
                                        <span class="text-sm font-black text-neon-green">+${points} XP</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error(error);
            }
        }

        async function loadLeaderboard(forceRefresh = false) {
            const container = document.getElementById('leaderboardContainer');
            
            try {
                // Check cache (unless force refresh)
                const now = Date.now();
                if (!forceRefresh && leaderboardCache && (now - leaderboardCacheTime) < LEADERBOARD_CACHE_DURATION) {
                    console.log('Using cached leaderboard data');
                    displayLeaderboard(leaderboardCache);
                    return;
                }
                
                // Show loading state
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="animate-spin text-4xl mb-2">‚ö°</div>
                        <div>Loading rankings...</div>
                    </div>
                `;
                
                const response = await fetch(`${API_URL}/leaderboard?limit=20`);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const leaders = await response.json();
                
                // Update cache
                leaderboardCache = leaders;
                leaderboardCacheTime = now;
                
                // Display leaderboard
                displayLeaderboard(leaders);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                container.innerHTML = `
                    <div class="text-center py-12 text-red-400">
                        <div class="text-5xl mb-3">‚ö†Ô∏è</div>
                        <div class="text-lg font-bold mb-1">Failed to Load Rankings</div>
                        <div class="text-sm mb-4">${error.message || 'Please try again later'}</div>
                        <button onclick="loadLeaderboard(true)" class="px-4 py-2 bg-neon-blue/20 hover:bg-neon-blue/30 border border-neon-blue rounded-lg transition-all">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function displayLeaderboard(leaders) {
            const container = document.getElementById('leaderboardContainer');
            
            // Check if leaderboard is empty
            if (!leaders || leaders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-5xl mb-3">üèÜ</div>
                        <div class="text-lg font-bold mb-1">No Players Yet</div>
                        <div class="text-sm">Complete quests to be the first on the leaderboard!</div>
                    </div>
                `;
                return;
            }
            
            // Display leaderboard
            container.innerHTML = leaders.map((user, i) => {
                const rank = i + 1;
                const rankDisplay = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${rank}`;
                const isCurrentUser = user.telegram_id === TELEGRAM_ID;
                const highlightClass = isCurrentUser ? 'border-brand-gold/50 bg-brand-gold/5' : 'border-neon-blue/30';
                
                return `
                    <div class="bg-gaming-darker/50 rounded-xl p-3 border ${highlightClass} flex items-center gap-3 hover:bg-gaming-darker/70 transition-all">
                        <div class="text-xl font-black w-10 text-center ${i < 3 ? 'text-2xl' : ''}">${rankDisplay}</div>
                        <div class="flex-1">
                            <div class="font-bold text-sm ${isCurrentUser ? 'text-brand-gold' : ''}">${user.username || 'Player'} ${isCurrentUser ? '(You)' : ''}</div>
                            <div class="text-xs text-gray-400">${user.completed_tasks || 0} quests completed</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-black text-neon-green">${user.points}</div>
                            <div class="text-xs text-gray-500">XP</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadRewards() {
            try {
                const response = await fetch(`${API_URL}/rewards`);
                const rewards = await response.json();
                const container = document.getElementById('rewardsContainer');
                
                container.innerHTML = rewards.map(reward => `
                    <div class="bg-gaming-dark/80 rounded-xl p-4 border border-neon-purple/30">
                        <div class="flex items-start gap-3">
                            <div class="text-3xl">üíé</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-sm mb-1">${reward.title}</h3>
                                <p class="text-xs text-gray-400 mb-2">${reward.description || ''}</p>
                                <div class="flex justify-between">
                                    <span class="text-xs text-gray-400">${reward.quantity_available || 0} left</span>
                                    <span class="text-sm font-black text-neon-pink">${reward.points_cost || 0} XP</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error(error);
            }
        }

        // Store user activities globally
        let userActivities = [];
        let currentActivityFilter = 'all';
        
        // Cache leaderboard data to avoid repeated API calls
        let leaderboardCache = null;
        let leaderboardCacheTime = 0;
        const LEADERBOARD_CACHE_DURATION = 30000; // 30 seconds

        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/users/${TELEGRAM_ID}`);
                const user = await response.json();
                const level = Math.floor(user.points / 100) + 1;
                
                document.getElementById('profileUsername').textContent = user.username || 'Player';
                document.getElementById('profileLevel').textContent = level;
                document.getElementById('profileXP').textContent = user.points;
                
                // Load quest activity first to get completed count
                await loadUserActivity();
                
                // Calculate completed quests from activity
                const completedCount = userActivities.filter(t => t.status === 'completed').length;
                document.getElementById('profileQuests').textContent = completedCount;
                
                // Load and calculate rank from leaderboard
                await loadUserRank(user.telegram_id, user.points);
            } catch (error) {
                console.error(error);
            }
        }

        async function loadUserRank(telegramId, userPoints) {
            try {
                // Fetch leaderboard (top 100 to find user rank)
                const response = await fetch(`${API_URL}/leaderboard?limit=100`);
                const leaderboard = await response.json();
                
                // Find user's rank
                const userRank = leaderboard.findIndex(u => u.telegram_id === telegramId) + 1;
                
                if (userRank > 0) {
                    document.getElementById('profileRank').textContent = `#${userRank}`;
                } else {
                    // User not in top 100, estimate rank
                    const usersAbove = leaderboard.filter(u => u.points > userPoints).length;
                    if (usersAbove === 100) {
                        document.getElementById('profileRank').textContent = '100+';
                    } else {
                        document.getElementById('profileRank').textContent = `#${usersAbove + 1}`;
                    }
                }
            } catch (error) {
                console.error('Error loading rank:', error);
                document.getElementById('profileRank').textContent = '-';
            }
        }

        async function loadUserActivity() {
            try {
                // Fetch user's task history
                const response = await fetch(`${API_URL}/users/${TELEGRAM_ID}/tasks`);
                const userTasks = await response.json();
                
                // Store activities
                userActivities = userTasks || [];
                
                // Calculate stats
                const successCount = userActivities.filter(t => t.status === 'completed').length;
                const failedCount = userActivities.filter(t => t.status === 'rejected').length;
                const totalAttempts = successCount + failedCount;
                const successRate = totalAttempts > 0 ? Math.round((successCount / totalAttempts) * 100) : 0;
                
                // Update stats display
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failedCount').textContent = failedCount;
                document.getElementById('successRate').textContent = successRate + '%';
                
                // Display activities
                displayActivities();
            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('activityContainer').innerHTML = `
                    <div class="text-center py-8 text-red-400 text-sm">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <div>Could not load activity</div>
                    </div>
                `;
            }
        }

        function displayActivities() {
            const container = document.getElementById('activityContainer');
            
            // Filter activities based on current filter
            let filteredActivities = userActivities;
            if (currentActivityFilter === 'success') {
                filteredActivities = userActivities.filter(t => t.status === 'completed');
            } else if (currentActivityFilter === 'failed') {
                filteredActivities = userActivities.filter(t => t.status === 'rejected');
            }
            
            // Sort by date (newest first)
            filteredActivities.sort((a, b) => new Date(b.completed_at || b.updated_at) - new Date(a.completed_at || a.updated_at));
            
            if (filteredActivities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 text-sm">
                        <div class="text-4xl mb-2">üéØ</div>
                        <div>${currentActivityFilter === 'all' ? 'Complete quests to see your activity!' : 'No ' + currentActivityFilter + ' quests found'}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredActivities.map(activity => {
                const isSuccess = activity.status === 'completed';
                const isFailed = activity.status === 'rejected';
                const isPending = !isSuccess && !isFailed;
                
                const statusColor = isSuccess ? 'green' : isFailed ? 'red' : 'yellow';
                const statusIcon = isSuccess ? '‚úÖ' : isFailed ? '‚ùå' : '‚è≥';
                const statusText = isSuccess ? 'SUCCESS' : isFailed ? 'FAILED' : 'PENDING';
                
                const date = new Date(activity.completed_at || activity.updated_at);
                const timeAgo = getTimeAgo(date);
                
                // Get XP - use points_earned if available, otherwise 0
                const xpEarned = activity.points_earned || 0;
                const points = isSuccess ? `+${xpEarned} XP` : isFailed ? '0 XP' : '...';
                
                return `
                    <div class="bg-gaming-darker/50 rounded-lg p-2.5 border-l-4 border-${statusColor}-500/50 hover:bg-gaming-darker/70 transition-all">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">${statusIcon}</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="text-sm font-bold">${activity.task_title || 'Quest'}</div>
                                    <div class="text-xs font-black ${isSuccess ? 'text-green-400' : isFailed ? 'text-red-400' : 'text-yellow-400'}">${points}</div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-${statusColor}-500/20 text-${statusColor}-400 font-semibold">${statusText}</span>
                                    <span class="text-xs text-gray-500">${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterActivity(filter) {
            currentActivityFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.activity-filter').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
            
            // Re-display activities
            displayActivities();
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function loadNotifications() {
            const container = document.getElementById('notificationsContainer');
            container.innerHTML = `
                <div class="bg-gaming-darker/50 rounded-lg p-3 border-l-4 border-neon-blue">
                    <div class="flex gap-3">
                        <span class="text-xl">‚öîÔ∏è</span>
                        <div class="flex-1">
                            <div class="text-sm font-bold">Quest Completed!</div>
                            <div class="text-xs text-gray-400">You earned 50 XP</div>
                            <div class="text-xs text-gray-500 mt-1">Just now</div>
                        </div>
                    </div>
                </div>
            `;
        }

        let currentTaskId = null;
        let currentTaskUrl = null;
        let currentTask = null;

        function showTaskDetail(taskIndex) {
            const task = window.tasksData[taskIndex];
            if (!task) return;
            
            currentTask = task;
            currentTaskId = task.id;
            currentTaskUrl = task.url;
            
            const platformEmoji = {
                'youtube': 'üì∫',
                'twitter': 'üê¶',
                'telegram': '‚úàÔ∏è',
                'discord': 'üí¨',
                'instagram': 'üì∑'
            }[task.platform] || 'üéØ';
            
            const platformName = task.platform || 'general';
            const points = task.points_reward || 0;
            
            document.getElementById('modalTitle').textContent = task.title;
            document.getElementById('modalDescription').textContent = task.description || 'Complete this quest to earn points!';
            document.getElementById('modalEmoji').textContent = platformEmoji;
            document.getElementById('modalPlatform').textContent = platformName.toUpperCase();
            document.getElementById('modalPoints').textContent = `+${points} XP`;
            
            // Show/hide code input based on task type
            const codeInputSection = document.getElementById('codeInputSection');
            const verificationData = task.verification_data || {};
            
            if (task.task_type === 'youtube_watch' && verificationData.method === 'time_delay_code') {
                codeInputSection.classList.remove('hidden');
                const delaySeconds = verificationData.delay_seconds || 0;
                const minutes = Math.floor(delaySeconds / 60);
                const seconds = delaySeconds % 60;
                document.getElementById('codeTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('verificationCode').value = '';
            } else {
                codeInputSection.classList.add('hidden');
            }
            
            document.getElementById('taskModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
            document.body.style.overflow = '';
            currentTaskId = null;
            currentTaskUrl = null;
            currentTask = null;
            document.getElementById('verificationCode').value = '';
        }

        async function completeTask() {
            if (!currentTaskId || !currentTaskUrl) return;
            
            // Check if code is required for YouTube quests
            const needsCode = currentTask && currentTask.task_type === 'youtube_watch' && 
                             currentTask.verification_data?.method === 'time_delay_code';
            
            if (needsCode) {
                const code = document.getElementById('verificationCode').value.trim();
                if (!code) {
                    alert('‚ö†Ô∏è Please enter the verification code from the video!');
                    return;
                }
            }
            
            // Open the task URL
            window.open(currentTaskUrl, '_blank');
            
            // Submit completion
            try {
                const requestBody = {
                    telegram_id: TELEGRAM_ID,
                    task_id: currentTaskId
                };
                
                // Add code if needed
                if (needsCode) {
                    requestBody.verification_code = document.getElementById('verificationCode').value.trim();
                }
                
                const response = await fetch(`${API_URL}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('üéâ Quest Completed! +' + result.points_earned + ' XP');
                    loadUserData();
                    loadTasks(); // Reload to hide completed tasks
                    closeTaskModal();
                } else {
                    // Check if task was already completed
                    if (result.message === 'Task already completed') {
                        alert('‚úÖ You already completed this quest!');
                        loadTasks(); // Reload to hide this task
                        closeTaskModal();
                    } else {
                        alert('‚ùå Verification failed: ' + (result.message || 'Please complete the task and try again'));
                    }
                }
            } catch (error) {
                console.error(error);
                alert('‚ö†Ô∏è Error verifying quest. Please try again.');
            }
        }

        // Close modal when clicking outside
        document.getElementById('taskModal').addEventListener('click', (e) => {
            if (e.target.id === 'taskModal') {
                closeTaskModal();
            }
        });

        // Check server status immediately
        checkServerStatus();
        // Check server status every 30 seconds
        setInterval(checkServerStatus, 30000);

        // Only load data if user has participated
        if (userHasParticipated) {
            loadUserData();
            loadTasks();
            setInterval(loadUserData, 30000);
        }
    </script>
</body>
</html>
